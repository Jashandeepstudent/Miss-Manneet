<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üíï Chat App (Firebase + Notifications) üíï</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getDatabase, ref, set, onChildAdded, get, child, query, limitToLast,
      onValue, onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAByLACmttf6BY6r0hEmZKYontfVqnDNpM",
      authDomain: "mndpschoolrspura.firebaseapp.com",
      projectId: "mndpschoolrspura",
      storageBucket: "mndpschoolrspura.firebasestorage.app",
      messagingSenderId: "810534224714",
      appId: "1:810534224714:web:a3055b4a6b3bca507337b3",
      measurementId: "G-2610K130EN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db);
    let currentUser = {};
    let screenHistory = [];
    let currentActiveRoom = null;
    let notifCount = 0;

    function ensureCurrentUserFromStorage() {
      if (!currentUser || !currentUser.userid) {
        try {
          const saved = localStorage.getItem("chatUser");
          if (saved) currentUser = JSON.parse(saved);
        } catch {}
      }
    }

    function showScreen(id) {
      resetScreens();
      document.getElementById(id).style.display = "block";
      screenHistory.push(id);
    }

    function goBack() {
      // remove current
      screenHistory.pop();
      resetScreens();
      let prev = screenHistory.pop();
      if (!prev) prev = "homeScreen";
      document.getElementById(prev).style.display = "block";
      screenHistory.push(prev);
      // update presence: leaving chat -> clear activeRoom
      if (currentActiveRoom && prev !== "chatScreen") {
        set(ref(db, "presence/" + currentUser.userid + "/activeRoom"), null).catch(()=>{});
        currentActiveRoom = null;
      }
    }

    window.nextStep = function () {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) { alert("Fill username and password"); return; }
      currentUser.username = username;
      currentUser.password = password;
      document.getElementById("step1").style.display = "none";
      document.getElementById("step2").style.display = "block";
    };

    window.finishRegister = function () {
      const userid = document.getElementById("userid").value.trim();
      if (!userid) { alert("Enter User ID"); return; }
      currentUser.userid = userid;
      set(ref(db, "users/" + userid), currentUser).then(() => {
        localStorage.setItem("chatUser", JSON.stringify(currentUser));
        document.getElementById("step2").style.display = "none";
        // show Home only (no auto-open)
        showHomeAfterLogin();
        // set initial presence (online but no activeRoom)
        try {
          set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: null });
          try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
          try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
        } catch(e) {}
      });
    };

    function showHomeAfterLogin() {
      // show only Home and show a suggestion banner ‚Äî do NOT auto-open chat rooms
      showScreen("homeScreen");
      document.getElementById("defaultWhiteBox").style.display = "flex";
      suggestLastChatBanner();
    }

    async function suggestLastChatBanner() {
      ensureCurrentUserFromStorage();
      const banner = document.getElementById("continueChatBanner");
      banner.innerHTML = ""; // clear
      if (!currentUser.userid) return;
      try {
        const matesSnap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (!matesSnap.exists()) {
          banner.innerHTML = ""; // no mates, no banner
          return;
        }
        const mates = matesSnap.val();
        let latest = { ts: 0, mateId: null, mateName: null, text: "" };
        const mateList = Object.values(mates);
        for (let i = 0; i < mateList.length; i++) {
          const m = mateList[i];
          const roomId = currentUser.userid < m.userid ? currentUser.userid + "_" + m.userid : m.userid + "_" + currentUser.userid;
          const lastMsgSnap = await get(query(ref(db, "chats/" + roomId), limitToLast(1)));
          if (lastMsgSnap.exists()) {
            const val = lastMsgSnap.val();
            const keys = Object.keys(val);
            if (keys.length) {
              const key = keys[0];
              const ts = Number(key) || 0;
              const msg = val[key];
              if (ts > latest.ts) {
                latest = { ts, mateId: m.userid, mateName: m.username, text: msg.text || "" };
              }
            }
          }
        }

        if (latest.ts > 0) {
          const snippet = latest.text.length > 60 ? latest.text.slice(0, 60) + "‚Ä¶" : latest.text;
          banner.innerHTML = `
            <div class="continueBanner">
              <div style="flex:1">
                <div style="font-weight:700">üìå Continue chat with ${escapeHtml(latest.mateName)}</div>
                <div style="font-size:13px;margin-top:6px;color:#333">"${escapeHtml(snippet)}"</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button onclick="openChatRoom('${latest.mateId}','${escapeJs(latest.mateName)}')">Open</button>
                <button onclick="document.getElementById('continueChatBanner').innerHTML=''">Dismiss</button>
              </div>
            </div>
          `;
        } else {
          banner.innerHTML = ""; // no messages at all
        }
      } catch (err) {
        banner.innerHTML = "";
        console.error("suggestLastChatBanner error:", err);
      }
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }
    function escapeJs(str) { return String(str || "").replace(/'/g, "\\'"); }

    window.showMyProfile = function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid || !currentUser.username) { alert("Please complete registration"); return; }
      viewProfile(currentUser.username, currentUser.userid, currentUser.password || "");
    };

    window.searchMate = async function () {
      const mateId = document.getElementById("searchInput").value.trim();
      const resultBox = document.getElementById("searchResult");
      resultBox.innerHTML = "";
      if (!mateId) { resultBox.innerText = "Enter a User ID to search."; return; }
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { resultBox.innerText = "Please login/register first."; return; }
      try {
        const snap = await get(child(dbRef, "users/" + mateId));
        if (snap.exists()) {
          const mate = snap.val();
          resultBox.innerHTML = `
            <div class="profileCard">
              <div class="pc-left"><div class="pc-avatar" onclick="viewProfile('${escapeJs(mate.username)}','${mate.userid}','')">üë§</div></div>
              <div class="pc-body">
                <div class="pc-name">${escapeHtml(mate.username)}</div>
                <div class="pc-id">ID: ${escapeHtml(mate.userid)}</div>
                <div class="pc-actions">
                  <button onclick="makeMate('${mate.userid}','${escapeJs(mate.username)}')">‚ûï Add Mate</button>
                </div>
              </div>
            </div>
          `;
        } else resultBox.innerText = "No user found.";
      } catch (err) {
        resultBox.innerText = "Error searching mate.";
      }
    };

    window.makeMate = function (mateId, mateName) {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      set(ref(db, "mates/" + currentUser.userid + "/" + mateId), { userid: mateId, username: mateName });
      set(ref(db, "mates/" + mateId + "/" + currentUser.userid), { userid: currentUser.userid, username: currentUser.username });
      document.getElementById("searchResult").innerHTML = `<div class="successMsg">Mate added successfully ‚úÖ</div>`;
    };

    window.openMatesPage = async function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("matesScreen");
      const list = document.getElementById("matesList");
      list.innerHTML = "";
      try {
        const snap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (snap.exists()) {
          const mates = snap.val();
          Object.values(mates).forEach(m => {
            const card = document.createElement("div");
            card.className = "mateCard";
            card.innerHTML = `
              <div class="mate-left" onclick="viewProfile('${escapeJs(m.username)}','${m.userid}','')">üë§</div>
              <div class="mate-mid">
                <div class="mname">${escapeHtml(m.username)}</div>
                <div class="mid">ID: ${escapeHtml(m.userid)}</div>
              </div>
            `;
            list.appendChild(card);
          });
        } else list.innerText = "No mates yet.";
      } catch { list.innerText = "Error loading mates."; }
    };

    window.viewProfile = function (name, id, pass) {
      showScreen("profileScreen");
      document.getElementById("profileContent").innerHTML = `
        <div class="profileBig">
          <div class="profileBigAvatar">üë§</div>
          <div class="profileBigInfo">
            <div class="profileBigName">${escapeHtml(name)}</div>
            <div style="margin-top:6px;">ID: <span class="highlightId">${escapeHtml(id)}</span></div>
            <div style="margin-top:6px;">Password: ${pass ? escapeHtml(pass) : '[hidden]'}</div>
          </div>
        </div>
      `;
    };

    function resetScreens() {
      ["homeScreen","matesScreen","profileScreen","chatScreen","chatRoomsScreen"].forEach(id => {
        document.getElementById(id).style.display = "none";
      });
    }

    // -- PRESENCE helpers --
    async function setPresenceOnline() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      try {
        set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: currentActiveRoom || null });
        try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
        try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
      } catch(e) { console.error("presence err", e); }
    }

    // -- Notifications: add and show --
    async function addNotificationForUser(toUserId, fromName, text, roomId) {
      try {
        const notifPath = "notifications/" + toUserId + "/" + Date.now();
        set(ref(db, notifPath), { from: fromName, text, roomId, ts: Date.now() });
      } catch(e){ console.error("notif add err", e); }
    }

    function showLocalPopup(notifKey, notif) {
      const popup = document.createElement("div");
      popup.className = "notifPopup";
      const time = new Date(notif.ts).toLocaleString();
      popup.innerHTML = `
        <div style="font-weight:700">${escapeHtml(notif.from)}</div>
        <div style="margin-top:6px">${escapeHtml(notif.text)}</div>
        <div style="font-size:12px;color:#666;margin-top:8px">${escapeHtml(time)}</div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button onclick="(function(){ openChatRoom('${notif.fromId || ""}','${escapeJs(notif.from)}'); this.closest('.notifPopup').remove(); })()">Open</button>
          <button onclick="this.closest('.notifPopup').remove()">Dismiss</button>
        </div>
      `;
      document.body.appendChild(popup);
      setTimeout(()=>{ try{ popup.remove(); }catch(e){} }, 6000);
    }

    // listen for notifications for current user and update bell
    function listenForNotifications() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      const notifRef = ref(db, "notifications/" + currentUser.userid);
      onChildAdded(notifRef, async (snap) => {
        const key = snap.key;
        const notif = snap.val();
        // If user is currently in the same room -> ignore and remove
        if (currentActiveRoom && notif.roomId === currentActiveRoom) {
          // remove server notification to keep DB clean
          try { remove(ref(db, "notifications/" + currentUser.userid + "/" + key)); } catch(e){}
          return;
        }
        // increment badge & add to list
        notifCount++;
        updateBellCount();
        addNotifToBellList(key, notif);
        // show transient popup
        showTransientNotification(notif, key);
      });
    }

    function updateBellCount() {
      const el = document.getElementById("notifCount");
      el.innerText = notifCount > 0 ? String(notifCount) : "";
    }

    function addNotifToBellList(key, notif) {
      const list = document.getElementById("notifList");
      const row = document.createElement("div");
      row.className = "notifRow";
      const time = new Date(notif.ts).toLocaleString();
      row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(notif.from)}</div><div style="font-size:13px;color:#333;margin-top:4px">${escapeHtml(notif.text)}</div><div style="font-size:11px;color:#666;margin-top:6px">${escapeHtml(time)}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button onclick="(function(){ openChatRoom('${notif.roomId.split('_').find(id=>id!==currentUser.userid)}','${escapeJs(notif.from)}'); markNotifRead('${key}'); })()">Open</button><button onclick="(function(){ markNotifRead('${key}'); })()">Dismiss</button></div>`;
      row.id = "notif_" + key;
      list.prepend(row);
    }

    function markNotifRead(key) {
      try { remove(ref(db, "notifications/" + currentUser.userid + "/" + key)); } catch(e){}
      const el = document.getElementById("notif_" + key);
      if (el) el.remove();
      notifCount = Math.max(0, notifCount - 1);
      updateBellCount();
    }

    function showTransientNotification(notif, key) {
      // create a small toast-like element
      const toast = document.createElement("div");
      toast.className = "toastNotif";
      const time = new Date(notif.ts).toLocaleString();
      toast.innerHTML = `<div style="font-weight:700">${escapeHtml(notif.from)}</div><div>${escapeHtml(notif.text)}</div><div style="font-size:11px;color:#666;margin-top:6px">${escapeHtml(time)}</div>`;
      document.body.appendChild(toast);
      // click to open
      toast.onclick = () => { openChatRoom(notif.roomId.split('_').find(id=>id!==currentUser.userid), notif.from); toast.remove(); };
      setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 5000);
    }

    window.openChatRoom = async function (mateId, mateName) {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("chatScreen");
      currentActiveRoom = currentUser.userid < mateId ? currentUser.userid + "_" + mateId : mateId + "_" + currentUser.userid;
      // update presence activeRoom
      try { set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: currentActiveRoom }); } catch(e) {}
      document.getElementById("chatWith").innerText = "Chatting with " + mateName;
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      // remove notifications for this room for current user (they are now viewing)
      try {
        const notifsSnap = await get(child(dbRef, "notifications/" + currentUser.userid));
        if (notifsSnap.exists()) {
          const notifs = notifsSnap.val();
          Object.keys(notifs).forEach(k => { if (notifs[k] && notifs[k].roomId === currentActiveRoom) remove(ref(db, "notifications/" + currentUser.userid + "/" + k)); });
        }
      } catch(e){}
      // load messages and subscribe
      const messagesRef = ref(db, "chats/" + currentActiveRoom);
      onChildAdded(messagesRef, (snapshot) => {
        const msg = snapshot.val();
        const ts = msg.ts || Number(snapshot.key) || Date.now();
        const time = new Date(ts).toLocaleString();
        const div = document.createElement("div");
        const me = msg.user === currentUser.username;
        div.className = "msgRow " + (me ? "me" : "them");
        div.innerHTML = `<div class="msgText"><strong>${escapeHtml(msg.user)}:</strong> ${escapeHtml(msg.text)}</div><div class="msgTime">${escapeHtml(time)}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
      document.getElementById("sendBtn").onclick = async () => {
        const text = document.getElementById("message").value.trim();
        if (!text) return;
        const ts = Date.now();
        await set(ref(db, "chats/" + currentActiveRoom + "/" + ts), { user: currentUser.username, text, ts });
        document.getElementById("message").value = "";
        // after sending, check mate presence and add notification only if mate not in the same activeRoom
        try {
          const matePresenceSnap = await get(child(dbRef, "presence/" + mateId));
          const matePresence = matePresenceSnap.exists() ? matePresenceSnap.val() : null;
          if (!(matePresence && matePresence.activeRoom === currentActiveRoom)) {
            // mate not in same room -> add notification for mate
            addNotificationForUser(mateId, currentUser.username, text, currentActiveRoom);
          }
        } catch(e) { console.error("presence check err", e); }
      };
    };

    window.viewChatRooms = async function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("chatRoomsScreen");
      const list = document.getElementById("chatRoomList");
      list.innerHTML = "";
      try {
        const snap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (snap.exists()) {
          const mates = snap.val();
          Object.values(mates).forEach(m => {
            const btn = document.createElement("div");
            btn.className = "roomRow";
            btn.innerHTML = `<div class="roomName">Chat with ${escapeHtml(m.username)}</div><div class="roomActions"><button onclick="openChatRoom('${m.userid}','${escapeJs(m.username)}')">Open</button></div>`;
            list.appendChild(btn);
          });
        } else list.innerText = "No chat rooms yet.";
      } catch { list.innerText = "Error loading chat rooms."; }
    };

    function checkFirebaseStatus() {
      try {
        set(ref(db, "status/test"), { ping: Date.now() });
        document.getElementById("fbStatus").innerText = "‚úÖ Firebase Connected";
      } catch {
        document.getElementById("fbStatus").innerText = "‚ùå Firebase Offline";
      }
    }

    window.onload = function () {
      const saved = localStorage.getItem("chatUser");
      if (saved) {
        try {
          currentUser = JSON.parse(saved);
          document.getElementById("step1").style.display = "none";
          showHomeAfterLogin();
          // initialize presence & notification listener
          setPresenceOnline();
          listenForNotifications();
        } catch {}
      }
      checkFirebaseStatus();
      // Bell click to toggle dropdown
      document.getElementById("notifBell").onclick = function(e) {
        const dropdown = document.getElementById("notifDropdown");
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
      };
      // click outside to close notif dropdown
      document.addEventListener("click", function(e){
        const dropdown = document.getElementById("notifDropdown");
        const bell = document.getElementById("notifBell");
        if (!bell.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = "none";
      });
    };
  </script>

  <style>
    :root{ --accent:#ff4d88;--bg:#fff5f9;--white:#ffffff; }
    body{background:var(--bg);font-family:Inter,Arial,sans-serif;margin:18px;}
    .screen{display:none;max-width:900px;margin:18px auto;background:var(--white);padding:28px;border-radius:20px;box-shadow:0 8px 25px rgba(0,0,0,0.08);position:relative;}
    h2{color:var(--accent);text-align:center;margin:8px 0 18px 0;}
    input,button{font-size:16px;border-radius:10px;border:1px solid #ddd;padding:12px;}
    button{background:var(--accent);color:white;border:none;cursor:pointer;}
    button:hover{opacity:0.95;}
    #defaultWhiteBox{display:none;border-radius:18px;padding:22px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;gap:18px;background:#fff;border:2px solid var(--accent);}
    .profileBubble{font-size:54px;cursor:pointer;}
    .mainOptions{display:flex;gap:14px;}
    .mainOptions button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;cursor:pointer;}
    .profileCard{display:flex;gap:12px;border:1px solid #f0f0f0;padding:12px;border-radius:12px;align-items:center;}
    .pc-avatar{font-size:42px;cursor:pointer;}
    .pc-name{font-weight:700;font-size:18px;color:#333;}
    .mateCard{display:flex;align-items:center;gap:12px;border:1px solid #f1f1f1;padding:12px;border-radius:12px;margin-bottom:10px;}
    .mate-left{font-size:34px;cursor:pointer;}
    .mname{font-weight:700;}
    .back-small{position:fixed;left:20px;bottom:20px;background:#444;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;}
    #chatBox{border:1px solid #eee;height:320px;overflow:auto;padding:12px;border-radius:12px;background:#fafafa;}
    /* messages: darker + bigger */
    .msgRow{padding:10px;margin-bottom:10px;border-radius:12px;max-width:75%;}
    .msgRow .msgText{font-size:16px;color:#111;font-weight:600;}
    .msgRow .msgTime{font-size:12px;color:#666;margin-top:6px;}
    .msgRow.me{background:#ffeef6;margin-left:auto;text-align:right;}
    .msgRow.them{background:#ffffff;margin-right:auto;text-align:left;}
    .roomRow{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #f1f1f1;border-radius:10px;margin-bottom:8px;}
    .profileBig{display:flex;gap:16px;align-items:center;padding:16px;border:1px solid #f1f1f1;border-radius:12px;background:#fff;}
    .profileBigAvatar{font-size:62px;}
    .profileBigName{font-weight:800;font-size:22px;color:#333;}
    .highlightId{font-weight:700;color:var(--accent);}
    .successMsg{color:green;font-weight:600;padding:10px;}
    #fbStatus{position:fixed;top:20px;right:20px;background:#000;color:#0f0;padding:8px 12px;border-radius:8px;font-size:13px;}
    /* continue banner */
    .continueBanner{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:#fff0f6;border:1px solid rgba(255,77,136,0.2);margin:12px 0;}
    .continueBanner button{background:#fff;color:var(--accent);border:1px solid var(--accent);padding:8px 12px;border-radius:8px;}
    /* notification UI */
    #notifBell{position:fixed;top:20px;left:20px;background:#fff;border:1px solid #eee;padding:8px 10px;border-radius:999px;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
    #notifBell .icon{font-size:18px;color:var(--accent);}
    #notifCount{background:var(--accent);color:#fff;border-radius:999px;padding:4px 8px;font-size:13px;}
    #notifDropdown{position:fixed;top:64px;left:20px;width:320px;background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;display:none;box-shadow:0 8px 30px rgba(0,0,0,0.08);max-height:420px;overflow:auto;z-index:9999;}
    .notifRow{display:flex;gap:12px;padding:10px;border-bottom:1px solid #f6f6f6;}
    .toastNotif{position:fixed;right:20px;bottom:20px;background:#fff;padding:12px;border-radius:12px;border:1px solid #eee;box-shadow:0 10px 30px rgba(0,0,0,0.08);z-index:9999;cursor:pointer;}
    .notifPopup{position:fixed;right:20px;bottom:90px;background:#fff;padding:12px;border-radius:12px;border:1px solid #eee;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:10000;}
  </style>
</head>
<body>
  <div id="notifBell"><span class="icon">üîî</span> <span id="notifCount"></span></div>
  <div id="notifDropdown"><div style="font-weight:800;margin-bottom:8px">Notifications</div><div id="notifList"></div></div>
  <div id="fbStatus">Checking Firebase...</div>

  <div id="step1" class="screen" style="display:block;">
    <h2>Step 1 ‚Äî Login</h2>
    <input id="username" placeholder="Username" />
    <input id="password" placeholder="Password" style="margin-top:8px;" />
    <div style="margin-top:12px;">
      <button onclick="nextStep()">Next ‚Üí</button>
    </div>
  </div>

  <div id="step2" class="screen">
    <h2>Step 2 ‚Äî Choose User ID</h2>
    <input id="userid" placeholder="User ID (unique)" />
    <div style="margin-top:12px;">
      <button onclick="finishRegister()">Finish & Go to Home</button>
    </div>
  </div>

  <div id="homeScreen" class="screen">
    <div id="defaultWhiteBox">
      <div style="display:flex;align-items:center;gap:18px;">
        <div class="profileBubble" onclick="showMyProfile()">üë§</div>
        <div style="font-weight:700;font-size:20px;color:var(--accent);">Main Options</div>
      </div>
      <div class="mainOptions">
        <button onclick="openMatesPage()">ü§ù Mates</button>
        <button onclick="viewChatRooms()">üí¨ Chat Rooms</button>
        <button onclick="searchMate()">üîç Search</button>
      </div>
    </div>

    <!-- banner area for "continue last chat" (NO auto-open) -->
    <div id="continueChatBanner"></div>

    <h2>Search your mate</h2>
    <input id="searchInput" placeholder="Enter mate UserID" />
    <div style="margin-top:10px;"><button onclick="searchMate()">Search Mate</button></div>
    <div id="searchResult" style="margin-top:12px;"></div>
  </div>

  <div id="matesScreen" class="screen">
    <h2>Your Mates</h2>
    <div id="matesList"></div>
    <button class="back-small" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="profileScreen" class="screen">
    <h2>Profile</h2>
    <div id="profileContent"></div>
    <button class="back-small" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="chatScreen" class="screen">
    <h2 id="chatWith"></h2>
    <div id="chatBox"></div>
    <div style="display:flex;gap:12px;margin-top:12px;">
      <input id="message" placeholder="Type a message..." style="flex:1;" />
      <button id="sendBtn">Send</button>
    </div>
    <button class="back-small" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="chatRoomsScreen" class="screen">
    <h2>Chat Rooms</h2>
    <div id="chatRoomList"></div>
    <button class="back-small" onclick="goBack()">‚¨Ö Back</button>
  </div>
</body>
</html>
