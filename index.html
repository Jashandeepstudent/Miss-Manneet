<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pink Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script>
  // Immediate redirect check
  (function() {
    const introSeen = localStorage.getItem('introSeen');
    if (introSeen !== 'true') {
      window.location.href = 'birthday.html';
    }
  })();
</script>
  <script type="module">
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getDatabase, ref, set, onChildAdded, get, child, query, limitToLast,
      
      onValue, onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAByLACmttf6BY6r0hEmZKYontfVqnDNpM",
      authDomain: "mndpschoolrspura.firebaseapp.com",
      projectId: "mndpschoolrspura",
      storageBucket: "mndpschoolrspura.firebasestorage.app",
      messagingSenderId: "810534224714",
      appId: "1:810534224714:web:a3055b4a6b3bca507337b3",
      measurementId: "G-2610K130EN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    const dbRef = ref(db);
    let currentUser = {};
    let screenHistory = [];
    let currentActiveRoom = null;
    let notifCount = 0;
    let notifCache = {}; // store loaded notifs
    let typingTimeouts = {};

    // Sticker emojis
    const stickers = ['ðŸ˜€','ðŸ˜‚','ðŸ˜','ðŸ¥°','ðŸ˜Ž','ðŸ¤”','ðŸ˜¢','ðŸ˜­','ðŸ˜¡','ðŸ¥³','ðŸŽ‰','â¤ï¸','ðŸ’•','ðŸ‘','ðŸ‘','ðŸ™','ðŸ”¥','âœ¨','ðŸŒŸ','â­','ðŸŽˆ','ðŸŽ','ðŸŒ¸','ðŸŒº','ðŸŒ¼','ðŸ’','ðŸ¦‹','ðŸŒˆ','â˜€ï¸','ðŸŒ™','ðŸ’«'];

    function ensureCurrentUserFromStorage() {
      if (!currentUser || !currentUser.userid) {
        try {
          const saved = localStorage.getItem("chatUser");
          if (saved) currentUser = JSON.parse(saved);
        } catch {}
      }
    }

    function showScreen(id) {
      resetScreens();
      document.getElementById(id).style.display = "block";
      // prevent duplicate consecutive entries
      if (screenHistory[screenHistory.length-1] !== id) screenHistory.push(id);
    }

    window.goBack = function() {
      if (screenHistory.length > 1) {
        screenHistory.pop();
        const prev = screenHistory[screenHistory.length - 1];
        resetScreens();
        document.getElementById(prev).style.display = "block";
      } else {
        resetScreens();
        document.getElementById("homeScreen").style.display = "block";
        screenHistory = ["homeScreen"];
      }
    }

    window.nextStep = function () {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) { alert("Fill username and password"); return; }
      currentUser.username = username;
      currentUser.password = password;
      document.getElementById("step1").style.display = "none";
      document.getElementById("step2").style.display = "block";
    };

    window.finishRegister = async function () {
      const userid = document.getElementById("userid").value.trim();
      const file = document.getElementById("profilePhoto").files[0];
      if (!userid) { alert("Enter User ID"); return; }
      currentUser.userid = userid;
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          currentUser.photo = e.target.result; // base64 string
          set(ref(db, "users/" + userid), currentUser).then(() => {
            localStorage.setItem("chatUser", JSON.stringify(currentUser));
            document.getElementById("step2").style.display = "none";
            showHomeAfterLogin();
            try{ updateProfileBubble(); }catch(e){}
            
            try {
              set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: null });
              try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
              try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
            } catch(e) {}
          });
        };
        reader.readAsDataURL(file);
      } else {
        set(ref(db, "users/" + userid), currentUser).then(() => {
          localStorage.setItem("chatUser", JSON.stringify(currentUser));
          document.getElementById("step2").style.display = "none";
          showHomeAfterLogin();
          try {
            set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: null });
            try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
            try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
          } catch(e) {}
        });
      }
    };

    function showHomeAfterLogin() {
      // show only Home and show a suggestion banner â€” do NOT auto-open chat rooms
      showScreen("homeScreen");
      document.getElementById("defaultWhiteBox").style.display = "flex";
      suggestLastChatBanner();
    }

    async function suggestLastChatBanner() {
      ensureCurrentUserFromStorage();
      const banner = document.getElementById("continueChatBanner");
      banner.innerHTML = ""; // clear
      if (!currentUser.userid) return;
      try {
        const matesSnap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (!matesSnap.exists()) {
          banner.innerHTML = ""; // no mates, no banner
          return;
        }
        const mates = matesSnap.val();
        let latest = { ts: 0, mateId: null, mateName: null, text: "" };
        const mateList = Object.values(mates);
        for (let i = 0; i < mateList.length; i++) {
          const m = mateList[i];
          const roomId = currentUser.userid < m.userid ? currentUser.userid + "_" + m.userid : m.userid + "_" + currentUser.userid;
          const lastMsgSnap = await get(query(ref(db, "chats/" + roomId), limitToLast(1)));
          if (lastMsgSnap.exists()) {
            const val = lastMsgSnap.val();
            const keys = Object.keys(val);
            if (keys.length) {
              const key = keys[0];
              const ts = Number(key) || 0;
              const msg = val[key];
              if (ts > latest.ts) {
                latest = { ts, mateId: m.userid, mateName: m.username, text: msg.text || "" };
              }
            }
          }
        }

        if (latest.ts > 0) {
          const snippet = latest.text.length > 60 ? latest.text.slice(0, 60) + "â€¦" : latest.text;
          banner.innerHTML = `
            <div class="continueBanner">
              <div style="flex:1">
                <div style="font-weight:700">ðŸ“Œ Continue chat with ${escapeHtml(latest.mateName)}</div>
                <div style="font-size:13px;margin-top:6px;color:#333">"${escapeHtml(snippet)}"</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button onclick="openChatRoom('${latest.mateId}','${escapeJs(latest.mateName)}')">Open</button>
                <button onclick="document.getElementById('continueChatBanner').innerHTML=''">Dismiss</button>
              </div>
            </div>
          `;
        } else {
          banner.innerHTML = ""; // no messages at all
        }
      } catch (err) {
        banner.innerHTML = "";
        console.error("suggestLastChatBanner error:", err);
      }
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }
    function escapeJs(str) { return String(str || "").replace(/'/g, "\\'"); }

function updateProfileBubble(){
      try{
        const el = document.getElementById("profileBubble");
        if(!el) return;
        if (currentUser && currentUser.photo) {
          el.innerHTML = '<img src="'+currentUser.photo+'" style="width:54px;height:54px;border-radius:50%;object-fit:cover;" />';
        } else {
          el.innerText = 'ðŸ‘¤';
        }
      }catch(e){}
    }

    // helper: show an editable profile form (vertical) and allow saving photo + credentials
    window.saveProfileEdits = async function(){
      try{
        const name = document.getElementById('edit_username').value.trim();
        const pass = document.getElementById('edit_password').value.trim();
        const file = document.getElementById('edit_profilePhoto').files[0];
        if(!name){ alert('Enter a username'); return; }
        currentUser.username = name;
        if(pass) currentUser.password = pass;
        if(file){
          const reader = new FileReader();
          reader.onload = async function(ev){
            currentUser.photo = ev.target.result;
            try{
              await set(ref(db, 'users/' + currentUser.userid), currentUser);
              localStorage.setItem('chatUser', JSON.stringify(currentUser));
              // propagate photo to other people's mate lists
              try{
                const matesSnap = await get(child(dbRef, 'mates/' + currentUser.userid));
                if(matesSnap.exists()){
                  const mates = matesSnap.val();
                  Object.keys(mates).forEach(mid => {
                    try{ set(ref(db, 'mates/' + mid + '/' + currentUser.userid + '/photo'), currentUser.photo); }catch(e){}
                  });
                }
              }catch(e){}
              updateProfileBubble();
              viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
              showCustomAlert('Profile saved');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save';
            }catch(e){ console.error(e); showCustomAlert('Error saving profile');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save'; }
          };
          reader.readAsDataURL(file);
        } else {
          try{
            await set(ref(db, 'users/' + currentUser.userid), currentUser);
            localStorage.setItem('chatUser', JSON.stringify(currentUser));
            updateProfileBubble();
            viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
            showCustomAlert('Profile saved');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save';
          }catch(e){ console.error(e); showCustomAlert('Error saving profile');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save'; }
        }
      }catch(e){ console.error(e); showCustomAlert('Error');
      document.querySelector('#editProfileSaveBtn').disabled=false;
      document.querySelector('#editProfileSaveBtn').innerText='Save'; }
    }

    function cancelEditProfile(){
      if(currentUser && currentUser.userid) viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
    }
        window.showMyProfile = function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid || !currentUser.username) { alert("Please complete registration"); return; }
      viewProfile(currentUser.username, currentUser.userid, currentUser.password || "");
    };

    window.searchMate = async function () {
      const mateId = document.getElementById("searchInput").value.trim();
      const resultBox = document.getElementById("searchResult");
      resultBox.innerHTML = "";
      if (!mateId) { resultBox.innerText = "Enter a User ID to search."; return; }
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { resultBox.innerText = "Please login/register first."; return; }
      try {
        const snap = await get(child(dbRef, "users/" + mateId));
        if (snap.exists()) {
          const mate = snap.val();
          resultBox.innerHTML = `
            <div class="profileCard">
              <div class="pc-left">
                ${mate.photo ? `<img src="${mate.photo}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;" />` : 'ðŸ‘¤'}
              </div>
              <div class="pc-body">
                <div class="pc-name">${escapeHtml(mate.username)}</div>
                <div class="pc-id">ID: ${escapeHtml(mate.userid)}</div>
                <div class="pc-actions">
                  <button onclick="makeMate('${mate.userid}','${escapeJs(mate.username)}')">âž• Add Mate</button>
                </div>
              </div>
            </div>
          `;
        } else resultBox.innerText = "No user found.";
      } catch (err) {
        resultBox.innerText = "Error searching mate.";
      }
    };

    window.makeMate = async function (mateId, mateName) {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      try {
        const snap = await get(child(dbRef, "users/" + mateId));
        const mate = snap.exists() ? snap.val() : null;
        const mateObj = { userid: mateId, username: mateName, photo: mate && mate.photo ? mate.photo : '' };
        await set(ref(db, "mates/" + currentUser.userid + "/" + mateId), mateObj);
        // reciprocate: include current user's photo as well
        const myObj = { userid: currentUser.userid, username: currentUser.username, photo: currentUser.photo || '' };
        await set(ref(db, "mates/" + mateId + "/" + currentUser.userid), myObj);
        document.getElementById("searchResult").innerHTML = `<div class="successMsg">Mate added successfully âœ…</div>`;
      } catch(e){
        console.error(e);
        document.getElementById("searchResult").innerHTML = `<div class="successMsg">Error adding mate</div>`;
      }
    };

    window.openMatesPage = async function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("matesScreen");
      const list = document.getElementById("matesList");
      list.innerHTML = "";
      try {
        const snap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (snap.exists()) {
          const mates = snap.val();
          Object.values(mates).forEach(m => {
            if (m.userid === currentUser.userid) return; // skip self
            if (m.userid === currentUser.userid) return; // skip self
            const card = document.createElement("div");
            card.className = "mateCard";
            card.innerHTML = `
              <div class="mate-left">
                ${m.photo ? `<img src="${m.photo}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" />` : 'ðŸ‘¤'}
              </div>
              <div class="mate-mid">
                <div class="mname">${escapeHtml(m.username)}</div>
                <div class="mid">ID: ${escapeHtml(m.userid)}</div>
              </div>
            `;
            list.appendChild(card);
          });
        } else list.innerText = "No mates yet.";
      } catch { list.innerText = "Error loading mates."; }
    };

    window.viewProfile = function (name, id, pass) {
      showScreen("profileScreen");
      // If viewing current user -> allow edit
      let photoHtml = "ðŸ‘¤";
      try {
        const userData = JSON.parse(localStorage.getItem("chatUser") || "{}");
        if (userData && userData.userid === id && userData.photo) {
          photoHtml = `<img src="${userData.photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;" />`;
        } else {
          // try to load photo from users/ node
          try{
            get(child(dbRef, 'users/' + id)).then(snap => {
              if(snap.exists() && snap.val().photo) {
                document.getElementById('profileContent').querySelector('.profileBigAvatar').innerHTML = `<img src="${snap.val().photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;" />`;
              }
            });
          }catch(e){}
        }
      } catch(e){}
      // If this is own profile, show editable vertical form
      const isMine = currentUser && currentUser.userid === id;
      if(isMine){
        document.getElementById("profileContent").innerHTML = `
          <div class="profileBig" style="flex-direction:column;align-items:flex-start;">
            <div class="profileBigAvatar">${photoHtml}</div>
            <div style="width:100%;margin-top:12px;display:flex;flex-direction:column;gap:8px;">
              <label style="font-weight:700">Username</label>
              <input id="edit_username" value="${escapeHtml(name)}" style="width:100%"/>
              <label style="font-weight:700">Password</label>
              <input id="edit_password" type="text" value="${escapeHtml(pass)}" style="width:100%"/>
              <label style="font-weight:700">User ID (readonly)</label>
              <input id="edit_userid" value="${escapeHtml(id)}" readonly style="width:100%;background:#f7f7f7"/>
              <label style="font-weight:700">Change photo (optional)</label>
              <input type="file" id="edit_profilePhoto" accept="image/*" capture="environment" />
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button id="editProfileSaveBtn" onclick="(function(btn){btn.disabled=true;btn.innerText='Saving...';saveProfileEdits();})(this)">Save</button>
                <button onclick="cancelEditProfile()" style="background:#fff;color:var(--accent);border:1px solid var(--accent)">Cancel</button>
              </div>
            </div>
          </div>
        `;
      } else {
        document.getElementById("profileContent").innerHTML = `
          <div class="profileBig">
            <div class="profileBigAvatar">${photoHtml}</div>
            <div class="profileBigInfo">
              <div class="profileBigName">${escapeHtml(name)}</div>
              <div style="margin-top:6px;">ID: <span class="highlightId">${escapeHtml(id)}</span></div>
              <div style="margin-top:6px;">Password: [hidden]</div>
            </div>
          </div>
        `;
      }
    };

function resetScreens() {
      ["homeScreen","matesScreen","profileScreen","chatScreen","chatRoomsScreen"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });
    }

    // -- PRESENCE helpers --
    async function setPresenceOnline() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      try {
        set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: currentActiveRoom || null });
        try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
        try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
      } catch(e) { console.error("presence err", e); }
    }

    // -- Notifications: add and show --
    async function addNotificationForUser(toUserId, fromName, text, roomId) {
      try {
        const notifPath = "notifications/" + toUserId + "/" + Date.now();
        set(ref(db, notifPath), { from: fromName, text, roomId, ts: Date.now() });
      } catch(e){ console.error("notif add err", e); }
    }

    function showLocalPopup(notifKey, notif) {
      const popup = document.createElement("div");
      popup.className = "notifPopup";
      const time = new Date(notif.ts).toLocaleString();
      popup.innerHTML = `
        <div style="font-weight:700">${escapeHtml(notif.from)}</div>
        <div style="margin-top:6px">${escapeHtml(notif.text)}</div>
        <div style="font-size:12px;color:#666;margin-top:8px">${escapeHtml(time)}</div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button onclick="(function(){ openChatRoom('${notif.fromId || ""}','${escapeJs(notif.from)}'); this.closest('.notifPopup').remove(); })()">Open</button>
          <button onclick="this.closest('.notifPopup').remove()">Dismiss</button>
        </div>
      `;
      document.body.appendChild(popup);
      setTimeout(()=>{ try{ popup.remove(); }catch(e){} }, 6000);
    }

    // listen for notifications for current user and update bell
    function listenForNotifications() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      const notifRef = ref(db, "notifications/" + currentUser.userid);
      onChildAdded(notifRef, async (snap) => {
        const key = snap.key;
        const notif = snap.val();
        // If user is currently in the same room -> ignore and remove
        if (currentActiveRoom && notif.roomId === currentActiveRoom) {
          // remove server notification to keep DB clean
          try { remove(ref(db, "notifications/" + currentUser.userid + "/" + key)); } catch(e){}
          return;
        }
        // increment badge & add to list
        notifCache[key] = notif;
        notifCount++;
        updateBellCount();
        addNotifToBellList(key, notif);
        // show transient popup
        showTransientNotification(notif, key);
      });
    }

    function updateBellCount() {
      const el = document.getElementById("notifCount");
      el.innerText = notifCount > 0 ? String(notifCount) : "";
    }

    function addNotifToBellList(key, notif) {
      const list = document.getElementById("notifList");
      const row = document.createElement("div");
      row.className = "notifRow";
      const time = new Date(notif.ts).toLocaleString();
      // infer mateId from roomId relative to current user
      const mateId = (notif.roomId || "").split('_').find(id=>id!==currentUser.userid) || "";
      row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(notif.from)}</div><div style="font-size:13px;color:#333;margin-top:4px">${escapeHtml(notif.text)}</div><div style="font-size:11px;color:#666;margin-top:6px">${escapeHtml(time)}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button onclick="(function(){ openChatRoom('${mateId}','${escapeJs(notif.from)}'); markNotifRead('${key}'); })()">Open</button><button onclick="markNotifRead('${key}')">Dismiss</button></div>`;
      row.id = "notif_" + key;
      list.prepend(row);
    }

    function markNotifRead(key) {
      try { remove(ref(db, "notifications/" + currentUser.userid + "/" + key)); } catch(e){}
      const el = document.getElementById("notif_" + key);
      if (el) el.remove();
      if (notifCache[key]) delete notifCache[key];
      notifCount = Math.max(0, notifCount - 1);
      updateBellCount();
    }

    function clearAllNotifications() {
      try {
        remove(ref(db, "notifications/" + currentUser.userid));
      } catch(e){}
      document.getElementById("notifList").innerHTML = "";
      notifCache = {};
      notifCount = 0;
      updateBellCount();
    }

    function showTransientNotification(notif, key) {
      // create a small toast-like element
      const toast = document.createElement("div");
      toast.className = "toastNotif";
      const time = new Date(notif.ts).toLocaleString();
      toast.innerHTML = `<div style="font-weight:700">${escapeHtml(notif.from)}</div><div>${escapeHtml(notif.text)}</div><div style="font-size:11px;color:#666;margin-top:6px">${escapeHtml(time)}</div>`;
      document.body.appendChild(toast);
      // click to open
      toast.onclick = () => { openChatRoom(notif.roomId.split('_').find(id=>id!==currentUser.userid), notif.from); toast.remove(); };
      setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 5000);
    }

    async function loadNotificationsList() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      const list = document.getElementById("notifList");
      list.innerHTML = "";
      notifCache = {};
      try {
        const snap = await get(child(dbRef, "notifications/" + currentUser.userid));
        if (!snap.exists()) {
          notifCount = 0;
          updateBellCount();
          list.innerHTML = "<div style='color:#666;padding:8px'>No notifications</div>";
          return;
        }
        const data = snap.val();
        const keys = Object.keys(data).sort((a,b)=>Number(b)-Number(a));
        notifCount = keys.length;
        updateBellCount();
        keys.forEach(k => { notifCache[k] = data[k]; addNotifToBellList(k, data[k]); });
      } catch(e){
        console.error("loadNotificationsList err", e);
      }
    }

    // Photo attachment helpers
    window.triggerPhotoChoose = function() {
      document.getElementById('photoInput').click();
    }

    window.handlePhotoSelect = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        const photoData = e.target.result;
        await sendMessageWithPhoto(photoData);
      };
      reader.readAsDataURL(file);
    }

    async function sendMessageWithPhoto(photoData) {
      if (!currentActiveRoom) return;
      const ts = Date.now();
      await set(ref(db, "chats/" + currentActiveRoom + "/" + ts), { 
        user: currentUser.username, 
        text: '', 
        photo: currentUser.photo || '',
        imageData: photoData, 
        ts 
      });
      // notification logic
      const mateId = currentActiveRoom.split('_').find(id=>id!==currentUser.userid);
      try {
        const matePresenceSnap = await get(child(dbRef, "presence/" + mateId));
        const matePresence = matePresenceSnap.exists() ? matePresenceSnap.val() : null;
        if (!(matePresence && matePresence.activeRoom === currentActiveRoom)) {
          addNotificationForUser(mateId, currentUser.username, 'ðŸ“· Photo', currentActiveRoom);
        }
      } catch(e) {}
    }

    // Sticker helpers
    window.toggleStickerPicker = function() {
      const picker = document.getElementById('stickerPicker');
      picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
    }

    window.sendSticker = async function(sticker) {
      if (!currentActiveRoom) return;
      const ts = Date.now();
      await set(ref(db, "chats/" + currentActiveRoom + "/" + ts), { 
        user: currentUser.username, 
        text: sticker, 
        photo: currentUser.photo || '',
        isSticker: true,
        ts 
      });
      document.getElementById('stickerPicker').style.display = 'none';
      // notification
      const mateId = currentActiveRoom.split('_').find(id=>id!==currentUser.userid);
      try {
        const matePresenceSnap = await get(child(dbRef, "presence/" + mateId));
        const matePresence = matePresenceSnap.exists() ? matePresenceSnap.val() : null;
        if (!(matePresence && matePresence.activeRoom === currentActiveRoom)) {
          addNotificationForUser(mateId, currentUser.username, sticker, currentActiveRoom);
        }
      } catch(e) {}
    }

    window.openChatRoom = async function (mateId, mateName) {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("chatScreen");
      currentActiveRoom = currentUser.userid < mateId ? currentUser.userid + "_" + mateId : mateId + "_" + currentUser.userid;
      // update presence activeRoom
      try { set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: currentActiveRoom }); } catch(e) {}
      document.getElementById("chatWith").innerText = mateName;
      document.getElementById("typingIndicator").innerText = "";
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      // remove notifications for this room for current user (they are now viewing)
      try {
        const notifsSnap = await get(child(dbRef, "notifications/" + currentUser.userid));
        if (notifsSnap.exists()) {
          const notifs = notifsSnap.val();
          Object.keys(notifs).forEach(k => { if (notifs[k] && notifs[k].roomId === currentActiveRoom) remove(ref(db, "notifications/" + currentUser.userid + "/" + k)); });
        }
      } catch(e){}
      // mark this room as read for current user
      try { set(ref(db, "reads/" + currentActiveRoom + "/" + currentUser.userid), Date.now()); } catch(e){}

      // subscribe to typing indicator for this room
      try {
        const typingRef = ref(db, "typing/" + currentActiveRoom);
        onValue(typingRef, (snap) => {
          const val = snap.val() || {};
          // remove own typing
          if (val[currentUser.userid]) delete val[currentUser.userid];
          const others = Object.keys(val || {}).filter(k=>val[k]);
          const indicator = document.getElementById("typingIndicator");
          if (others.length) {
            indicator.innerText = "typing...";
          } else {
            indicator.innerText = "";
          }
        });
      } catch(e){ console.error("typing listen err", e); }

      // load messages and subscribe
      const messagesRef = ref(db, "chats/" + currentActiveRoom);
      onChildAdded(messagesRef, async (snapshot) => {
        const msg = snapshot.val();
        const ts = msg.ts || Number(snapshot.key) || Date.now();
        const time = new Date(ts).toLocaleString();
        const div = document.createElement("div");
        const me = msg.user === currentUser.username;
        div.className = "msgRow " + (me ? "me" : "them");

        // compute ticks: check reads for this room
        let isRead = false;
        try {
          const readsSnap = await get(child(dbRef, "reads/" + currentActiveRoom));
          if (readsSnap.exists()) {
            const reads = readsSnap.val();
            // mateId is the one that's not currentUser in roomId
            const mateIdFromRoom = currentActiveRoom.split('_').find(id=>id!==currentUser.userid);
            if (reads && mateIdFromRoom && reads[mateIdFromRoom] && Number(reads[mateIdFromRoom]) >= Number(ts)) {
              isRead = true;
            }
          }
        } catch(e){}

        // avatar (use msg.photo if present)
        let avatarHtml = (msg.photo && msg.photo.length) ? `<img src="${msg.photo}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;" />` : 'ðŸ‘¤';
        
        // Check if message has image
        let contentHtml = '';
        if (msg.imageData) {
          contentHtml = `<img src="${msg.imageData}" style="max-width:200px;max-height:200px;border-radius:12px;cursor:pointer;" onclick="window.open('${msg.imageData}','_blank')" />`;
        } else if (msg.isSticker) {
          contentHtml = `<div style="font-size:48px;">${escapeHtml(msg.text)}</div>`;
        } else {
          contentHtml = `<div style="word-wrap:break-word;word-break:break-word;white-space:pre-wrap;">${escapeHtml(msg.text)}</div>`;
        }

        const ticksHtml = me ? `<div class="msgTicks">${ isRead ? 'âœ”âœ”' : 'âœ”' }</div>` : '';
        
        if (me) {
          div.innerHTML = `<div style="display:flex;align-items:flex-end;justify-content:flex-end;gap:8px;"><div class="msgBubble">${contentHtml}</div><div class="msgAvatar">${avatarHtml}</div></div><div class="msgTime">${escapeHtml(time)} ${ticksHtml}</div>`;
        } else {
          div.innerHTML = `<div style="display:flex;align-items:flex-end;gap:8px;"><div class="msgAvatar">${avatarHtml}</div><div><div class="msgBubble"><div style="font-weight:700;margin-bottom:4px;font-size:13px;">${escapeHtml(msg.user)}</div>${contentHtml}</div><div class="msgTime">${escapeHtml(time)}</div></div></div>`;
        }
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      document.getElementById("sendBtn").onclick = async () => {
        const text = document.getElementById("message").value.trim();
        if (!text) return;
        const ts = Date.now();
        await set(ref(db, "chats/" + currentActiveRoom + "/" + ts), { user: currentUser.username, text, ts, photo: currentUser.photo || '' });
        document.getElementById("message").value = "";
        // after sending, check mate presence and add notification only if mate not in the same activeRoom
        try {
          const matePresenceSnap = await get(child(dbRef, "presence/" + mateId));
          const matePresence = matePresenceSnap.exists() ? matePresenceSnap.val() : null;
          if (!(matePresence && matePresence.activeRoom === currentActiveRoom)) {
            // mate not in same room -> add notification for mate
            addNotificationForUser(mateId, currentUser.username, text, currentActiveRoom);
          } else {
            // if mate is in same room, mark reads for both so ticks show as read
            try { set(ref(db, "reads/" + currentActiveRoom + "/" + currentUser.userid), Date.now()); } catch(e){}
          }
        } catch(e) { console.error("presence check err", e); }
      };
    };

    window.viewChatRooms = async function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("chatRoomsScreen");
      const list = document.getElementById("chatRoomList");
      list.innerHTML = "";
      try {
        const snap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (snap.exists()) {
          const mates = snap.val();
          Object.values(mates).forEach(m => {
            if (m.userid === currentUser.userid) return; // skip self
            const btn = document.createElement("div");
            btn.className = "roomRow";
            btn.innerHTML = `<div class="roomAvatar">${m.photo ? `<img src="${m.photo}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" />` : 'ðŸ‘¤'}</div><div class="roomName">${escapeHtml(m.username)}</div><div class="roomActions"><button onclick="openChatRoom('${m.userid}','${escapeJs(m.username)}')">Open</button></div>`;
            list.appendChild(btn);
          });
        } else list.innerText = "No chat rooms yet.";
      } catch { list.innerText = "Error loading chat rooms."; }
    };

    function checkFirebaseStatus() {
      try {
        set(ref(db, "status/test"), { ping: Date.now() });
        var el=document.getElementById("fbStatus"); if(el) el.innerText="âœ… Firebase Connected";
      } catch {
        var el=document.getElementById("fbStatus"); if(el) el.innerText="âŒ Firebase Offline";
      }
    }

    // typing helpers
    function setTypingFlag(roomId, turningOn) {
      if (!roomId) return;
      try {
        set(ref(db, "typing/" + roomId + "/" + currentUser.userid), turningOn ? true : null);
      } catch(e){ console.error("setTypingFlag err", e); }
    }
    function debounceSetTyping(roomId, on) {
      if (!roomId) return;
      if (typingTimeouts[roomId]) clearTimeout(typingTimeouts[roomId]);
      setTypingFlag(roomId, on);
      typingTimeouts[roomId] = setTimeout(()=>{ setTypingFlag(roomId, false); }, 2000);
    }

    window.onload = function () {
      const saved = localStorage.getItem("chatUser");
      if (saved) {
        try {
          currentUser = JSON.parse(saved);
          document.getElementById("step1").style.display = "none";
          showHomeAfterLogin();
          try{ updateProfileBubble(); }catch(e){}
          // initialize presence & notification listener
          setPresenceOnline();
          listenForNotifications();
        } catch {}
      }
      checkFirebaseStatus();
      
      // Populate sticker picker
      const stickerGrid = document.getElementById('stickerGrid');
      stickers.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'stickerBtn';
        btn.innerText = s;
        btn.onclick = () => sendSticker(s);
        stickerGrid.appendChild(btn);
      });

      // Bell click to toggle dropdown and load notifications
      document.getElementById("notifBell").onclick = async function (e) {
        e.stopPropagation();
        const dropdown = document.getElementById("notifDropdown");
        if (dropdown.style.display === "block") {
          dropdown.style.display = "none";
        } else {
          dropdown.style.display = "block";
          await loadNotificationsList();
        }
      };
      // "mark all read" control
      document.getElementById("markAllReadBtn").onclick = function(){ clearAllNotifications(); };

      // click outside to close notif dropdown
      document.addEventListener("click", function(e){
        const dropdown = document.getElementById("notifDropdown");
        const bell = document.getElementById("notifBell");
        if (!bell.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = "none";
      });

      // typing UI hooks on message input
      const messageInput = document.getElementById("message");
      messageInput.addEventListener("input", function(){
        if (!currentActiveRoom) return;
        debounceSetTyping(currentActiveRoom, true);
      });
      messageInput.addEventListener("focus", function(){
        if (!currentActiveRoom) return;
        setTypingFlag(currentActiveRoom, true);
      });
      messageInput.addEventListener("blur", function(){
        if (!currentActiveRoom) return;
        setTypingFlag(currentActiveRoom, false);
      });
    };
  </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{ 
      --primary-pink:#ff4d88;
      --light-pink:#fff0f6;
      --lighter-pink:#fff5f9;
      --white:#ffffff; 
      --blue:#3b82f6;
      --gray:#666;
      --light-gray:#f5f5f5;
    }
    body{
      background: linear-gradient(135deg, var(--lighter-pink) 0%, #ffe8f0 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .screen{
      display:none;
      max-width:900px;
      margin:20px auto;
      background:var(--white);
      padding:24px;
      border-radius:24px;
      box-shadow:0 10px 40px rgba(255,77,136,0.15);
      position:relative;
    }
    h2{
      color:var(--primary-pink);
      text-align:center;
      margin:0 0 20px 0;
      font-size:24px;
      font-weight:700;
    }
    input,button{
      font-size:15px;
      border-radius:12px;
      border:1px solid #e5e5e5;
      padding:12px 16px;
      font-family: inherit;
    }
    input:focus{
      outline: none;
      border-color: var(--primary-pink);
      box-shadow: 0 0 0 3px rgba(255,77,136,0.1);
    }
    button{
      background:var(--primary-pink);
      color:white;
      border:none;
      cursor:pointer;
      font-weight:600;
      transition: all 0.3s ease;
    }
    button:hover{
      background:#ff2d6f;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255,77,136,0.3);
    }
    button:active{
      transform: translateY(0);
    }
    #defaultWhiteBox{
      display:none;
      border-radius:20px;
      padding:20px;
      margin-bottom:20px;
      background:linear-gradient(135deg, var(--white) 0%, var(--light-pink) 100%);
      border:2px solid var(--primary-pink);
      box-shadow: 0 4px 15px rgba(255,77,136,0.1);
    }
    .profileBubble{
      font-size:54px;
      cursor:pointer;
      transition: transform 0.3s ease;
    }
    .profileBubble:hover{
      transform: scale(1.1);
    }
    .mainOptions{
      display:flex;
      gap:12px;
      flex-wrap: wrap;
    }
    .mainOptions button{
      padding:12px 20px;
      border-radius:12px;
      flex: 1;
      min-width: 100px;
    }
    .profileCard{
      display:flex;
      gap:16px;
      border:2px solid var(--light-pink);
      padding:16px;
      border-radius:16px;
      align-items:center;
      background: var(--white);
      transition: all 0.3s ease;
    }
    .profileCard:hover{
      border-color: var(--primary-pink);
      box-shadow: 0 6px 20px rgba(255,77,136,0.15);
    }
    .pc-name{
      font-weight:700;
      font-size:18px;
      color:#222;
    }
    .pc-id{
      color: var(--gray);
      margin-top: 4px;
      font-size: 14px;
    }
    .mateCard{
      display:flex;
      align-items:center;
      gap:14px;
      border:2px solid var(--light-pink);
      padding:14px;
      border-radius:16px;
      margin-bottom:12px;
      background: var(--white);
      transition: all 0.3s ease;
    }
    .mateCard:hover{
      border-color: var(--primary-pink);
      transform: translateX(4px);
    }
    .mname{
      font-weight:700;
      font-size: 16px;
    }
    .mid{
      color: var(--gray);
      font-size: 13px;
      margin-top: 2px;
    }
    .back-small{
      position:fixed;
      left:20px;
      bottom:20px;
      background:var(--blue);
      color:#fff;
      padding:12px 20px;
      border-radius:50px;
      cursor:pointer;
      border:none;
      box-shadow: 0 6px 20px rgba(59,130,246,0.3);
      font-weight: 600;
      z-index: 1000;
    }
    #chatBox{
      border:2px solid var(--light-pink);
      height:400px;
      overflow-y:auto;
      padding:16px;
      border-radius:16px;
      background: var(--lighter-pink);
      margin-bottom: 12px;
    }
    
    /* Improved message bubbles */
    .msgRow{
      padding:8px 0;
      margin-bottom:12px;
      display: flex;
      flex-direction: column;
    }
    .msgBubble{
      padding:12px 16px;
      border-radius:18px;
      max-width:70%;
      font-size:15px;
      line-height: 1.4;
      word-wrap: break-word;
      word-break: break-word;
      white-space: pre-wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .msgRow.me .msgBubble{
      background: linear-gradient(135deg, var(--primary-pink) 0%, #ff6b9d 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .msgRow.them .msgBubble{
      background: var(--white);
      color: #222;
      border-bottom-left-radius: 4px;
      border: 1px solid var(--light-pink);
    }
    .msgRow .msgTime{
      font-size:11px;
      color: var(--gray);
      margin-top:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .msgRow.me{
      align-items: flex-end;
    }
    .msgRow.them{
      align-items: flex-start;
    }
    
    .roomRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px;
      border:2px solid var(--light-pink);
      border-radius:16px;
      margin-bottom:12px;
      background: var(--white);
      transition: all 0.3s ease;
    }
    .roomRow:hover{
      border-color: var(--primary-pink);
      box-shadow: 0 6px 20px rgba(255,77,136,0.15);
    }
    .roomAvatar{
      margin-right: 12px;
    }
    .roomName{
      flex: 1;
      font-weight: 600;
      font-size: 16px;
    }
    .profileBig{
      display:flex;
      gap:20px;
      align-items:center;
      padding:20px;
      border:2px solid var(--light-pink);
      border-radius:16px;
      background: var(--white);
    }
    .profileBigAvatar{
      font-size:80px;
    }
    .profileBigName{
      font-weight:800;
      font-size:24px;
      color:#222;
    }
    .highlightId{
      font-weight:700;
      color:var(--primary-pink);
    }
    .successMsg{
      color:#10b981;
      font-weight:600;
      padding:12px;
      background: #ecfdf5;
      border-radius: 12px;
      border: 1px solid #10b981;
    }
   
    /* continue banner */
    .continueBanner{
      display:flex;
      gap:16px;
      align-items:center;
      padding:16px;
      border-radius:16px;
      background: linear-gradient(135deg, var(--white) 0%, var(--light-pink) 100%);
      border:2px solid var(--primary-pink);
      margin:16px 0;
      box-shadow: 0 4px 15px rgba(255,77,136,0.1);
    }
    .continueBanner button{
      background:var(--white);
      color:var(--primary-pink);
      border:2px solid var(--primary-pink);
      padding:8px 16px;
      border-radius:10px;
    }
    
    /* notification UI */
    #notifBell{
      position:fixed;
      top:16px;
      left:16px;
      z-index:20000;
      background:var(--white);
      border:2px solid var(--light-pink);
      padding:10px 14px;
      border-radius:50px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 6px 20px rgba(255,77,136,0.15);
      transition: all 0.3s ease;
    }
    #notifBell:hover{
      box-shadow:0 8px 25px rgba(255,77,136,0.25);
      transform: translateY(-2px);
    }
    #notifBell .icon{
      font-size:20px;
      color:var(--primary-pink);
    }
    #notifCount{
      background:var(--primary-pink);
      color:#fff;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      font-weight: 700;
    }
    #notifDropdown{
      position:fixed;
      top:80px;
      left:20px;
      width:360px;
      background:var(--white);
      border:2px solid var(--light-pink);
      border-radius:16px;
      padding:16px;
      display:none;
      box-shadow:0 10px 40px rgba(255,77,136,0.2);
      max-height:450px;
      overflow-y:auto;
      z-index:10000;
    }
    .notifRow{
      display:flex;
      gap:12px;
      padding:12px;
      border-bottom:1px solid var(--light-pink);
      transition: background 0.2s ease;
    }
    .notifRow:hover{
      background: var(--lighter-pink);
    }
    .toastNotif{
      position:fixed;
      right:20px;
      bottom:20px;
      background:var(--white);
      padding:16px;
      border-radius:16px;
      border:2px solid var(--primary-pink);
      box-shadow:0 10px 40px rgba(255,77,136,0.2);
      z-index:10000;
      cursor:pointer;
      max-width: 300px;
    }
    .notifPopup{
      position:fixed;
      right:20px;
      bottom:100px;
      background:var(--white);
      padding:16px;
      border-radius:16px;
      border:2px solid var(--primary-pink);
      box-shadow:0 10px 40px rgba(255,77,136,0.25);
      z-index:10000;
      max-width: 300px;
    }
    .msgTicks{
      font-size:12px;
      color:#fff;
      font-weight:700;
      margin-left:4px;
    }
    #typingIndicator{
      font-size:13px;
      color:var(--gray);
      margin-bottom:8px;
      font-style: italic;
      height: 18px;
    }
    .msgAvatar{
      font-size:36px;
      flex-shrink: 0;
    }
    
    /* Photo and sticker controls */
    .chatInputControls{
      display: flex;
      gap: 8px;
      margin-top: 12px;
      align-items: center;
    }
    .chatInputControls input{
      flex: 1;
    }
    .iconBtn{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--white);
      border: 2px solid var(--light-pink);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      padding: 0;
    }
    .iconBtn:hover{
      background: var(--light-pink);
      border-color: var(--primary-pink);
      transform: translateY(-2px);
    }
    .iconBtn svg{
      width: 22px;
      height: 22px;
      fill: var(--primary-pink);
    }
    #photoInput{
      display: none;
    }
    #stickerPicker{
      position: absolute;
      bottom: 70px;
      right: 20px;
      background: var(--white);
      border: 2px solid var(--primary-pink);
      border-radius: 16px;
      padding: 12px;
      display: none;
      flex-wrap: wrap;
      gap: 8px;
      width: 280px;
      max-height: 240px;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(255,77,136,0.2);
      z-index: 100;
    }
    .stickerBtn{
      width: 48px;
      height: 48px;
      font-size: 28px;
      background: var(--lighter-pink);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0;
    }
    .stickerBtn:hover{
      background: var(--light-pink);
      transform: scale(1.15);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      body{
        padding: 0;
        margin: 0;
      }
      .screen{
        margin: 10px;
        padding: 16px;
        border-radius: 16px;
      }
      h2{
        font-size: 20px;
      }
      input, button{
        font-size: 14px;
        padding: 10px 14px;
      }
      .mainOptions{
        flex-direction: column;
      }
      .mainOptions button{
        width: 100%;
      }
      #defaultWhiteBox{
        flex-direction: column;
        gap: 16px;
        padding: 16px;
      }
      .profileBubble{
        font-size: 48px;
      }
      #chatBox{
        height: 300px;
      }
      .msgBubble{
        max-width: 85%;
        font-size: 14px;
      }
      #notifDropdown{
        width: calc(100vw - 40px);
        left: 20px;
        right: 20px;
      }
      #stickerPicker{
        width: calc(100vw - 40px);
        right: 20px;
        left: 20px;
      }
      .back-small{
        left: 50%;
        transform: translateX(-50%);
        bottom: 16px;
      }
      .chatInputControls{
        flex-wrap: wrap;
      }
      .chatInputControls input{
        width: 100%;
      }
      .iconBtn{
        width: 40px;
        height: 40px;
      }
    }

    #fbStatus { display: none !important; }
  </style>
</head>
<body>
  <div id="notifBell"><span class="icon">ðŸ””</span> <span id="notifCount"></span></div>
  <div id="notifDropdown">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:800;font-size:16px;">Notifications</div>
      <button id="markAllReadBtn" style="background:#fff;color:var(--primary-pink);border:2px solid var(--primary-pink);padding:6px 12px;border-radius:10px;font-size:13px;">Clear All</button>
    </div>
    <div id="notifList"></div>
  </div>


  <div id="step1" class="screen" style="display:block;">
    <h2>âœ¨ Welcome to Pink Chat</h2>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <input id="username" placeholder="Enter your username" style="width:100%" />
      <input id="password" type="text" placeholder="Enter your password" style="width:100%" />
    </div>
    <div style="margin-top:16px;">
      <button onclick="nextStep()" style="width:100%;">Next â†’</button>
    </div>
  </div>

  <div id="step2" class="screen">
    <h2>ðŸ“ Choose Your ID</h2>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <input id="userid" placeholder="Enter unique User ID" style="width:100%" />
      <label style="font-size:14px;color:var(--gray);font-weight:600;">Profile Photo (optional)</label>
      <input type="file" id="profilePhoto" accept="image/*" capture="environment" style="margin-top:6px;" />
    </div>
    <div style="margin-top:16px;">
      <button onclick="finishRegister()" style="width:100%;">Complete & Start Chatting</button>
    </div>
  </div>

  <div id="homeScreen" class="screen">
    <div id="defaultWhiteBox">
      <div style="display:flex;align-items:center;gap:18px;">
        <div class="profileBubble" id="profileBubble" onclick="showMyProfile()">ðŸ‘¤</div>
        <div style="font-weight:700;font-size:20px;color:var(--primary-pink);">Pink Chat</div>
      </div>
      <div class="mainOptions">
        <button onclick="openMatesPage()">ðŸ¤ My Mates</button>
        <button onclick="viewChatRooms()">ðŸ’¬ Chats</button>
        <button onclick="searchMate()">ðŸ” Find Friends</button>
      </div>
    </div>

    <div id="continueChatBanner"></div>

    <h2>ðŸ” Find Your Mate</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <input id="searchInput" placeholder="Enter mate's User ID" style="flex:1;min-width:200px;" />
      <button onclick="searchMate()">Search</button>
    </div>
    <div id="searchResult" style="margin-top:16px;"></div>
  </div>

  <div id="matesScreen" class="screen">
    <h2>ðŸ‘¥ Your Mates</h2>
    <div id="matesList"></div>
    <button class="back-small" onclick="goBack()">â¬… Back</button>
  </div>

  <div id="profileScreen" class="screen">
    <h2>ðŸ‘¤ Profile</h2>
    <div id="profileContent"></div>
    <button class="back-small" onclick="goBack()">â¬… Back</button>
  </div>

  <div id="chatScreen" class="screen">
    <h2 id="chatWith"></h2>
    <div id="typingIndicator"></div>
    <div id="chatBox"></div>
    
    <div class="chatInputControls">
      <input id="message" placeholder="Type a message..." />
      <button class="iconBtn" onclick="triggerPhotoChoose()" title="Send Photo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
      </button>
      <button class="iconBtn" onclick="toggleStickerPicker()" title="Send Sticker">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
      </button>
      <button id="sendBtn">Send</button>
    </div>
    
    <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhotoSelect(this)" />
    
    <div id="stickerPicker">
      <div id="stickerGrid"></div>
    </div>
    
    <button class="back-small" onclick="goBack()">â¬… Back</button>
  </div>

  <div id="chatRoomsScreen" class="screen">
    <h2>ðŸ’¬ Chat Rooms</h2>
    <div id="chatRoomList"></div>
    <button class="back-small" onclick="goBack()">â¬… Back</button>
  </div>

  <div id="customAlert" style="display:none;position:fixed;top:20px;right:20px;
  background:#10b981;color:#fff;padding:14px 20px;border-radius:12px;
  box-shadow:0 6px 20px rgba(16,185,129,0.3);z-index:10000;font-weight:600;">
    âœ… Profile updated successfully!
  </div>
  <script>
  function showCustomAlert(msg){
    const box=document.getElementById("customAlert");
    box.innerText=msg;
    box.style.display="block";
    setTimeout(()=>{box.style.display="none";"},3000);
  }
  </script>

  <div id="fbStatus" style="margin:10px;font-size:14px;color:#555"></div>
</body>
</html>
