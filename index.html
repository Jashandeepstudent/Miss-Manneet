<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üíï Chat App For Jashan and Miss Manneet</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getDatabase, ref, set, onChildAdded, get, child, query, limitToLast,
      
      onValue, onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAByLACmttf6BY6r0hEmZKYontfVqnDNpM",
      authDomain: "mndpschoolrspura.firebaseapp.com",
      projectId: "mndpschoolrspura",
      storageBucket: "mndpschoolrspura.firebasestorage.app",
      messagingSenderId: "810534224714",
      appId: "1:810534224714:web:a3055b4a6b3bca507337b3",
      measurementId: "G-2610K130EN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    const dbRef = ref(db);
    let currentUser = {};
    let screenHistory = [];
    let currentActiveRoom = null;
    let notifCount = 0;
    let notifCache = {}; // store loaded notifs
    let typingTimeouts = {};

    function ensureCurrentUserFromStorage() {
      if (!currentUser || !currentUser.userid) {
        try {
          const saved = localStorage.getItem("chatUser");
          if (saved) currentUser = JSON.parse(saved);
        } catch {}
      }
    }

    function showScreen(id) {
      resetScreens();
      document.getElementById(id).style.display = "block";
      // prevent duplicate consecutive entries
      if (screenHistory[screenHistory.length-1] !== id) screenHistory.push(id);
    }

    window.goBack = function() {
      if (screenHistory.length > 1) {
        screenHistory.pop();
        const prev = screenHistory[screenHistory.length - 1];
        resetScreens();
        document.getElementById(prev).style.display = "block";
      } else {
        resetScreens();
        document.getElementById("homeScreen").style.display = "block";
        screenHistory = ["homeScreen"];
      }
    }

    window.nextStep = function () {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) { alert("Fill username and password"); return; }
      currentUser.username = username;
      currentUser.password = password;
      document.getElementById("step1").style.display = "none";
      document.getElementById("step2").style.display = "block";
    };

    window.finishRegister = async function () {
      const userid = document.getElementById("userid").value.trim();
      const file = document.getElementById("profilePhoto").files[0];
      if (!userid) { alert("Enter User ID"); return; }
      currentUser.userid = userid;
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          currentUser.photo = e.target.result; // base64 string
          set(ref(db, "users/" + userid), currentUser).then(() => {
            localStorage.setItem("chatUser", JSON.stringify(currentUser));
            document.getElementById("step2").style.display = "none";
            showHomeAfterLogin();
            try{ updateProfileBubble(); }catch(e){}
            
            try {
              set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: null });
              try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
              try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
            } catch(e) {}
          });
        };
        reader.readAsDataURL(file);
      } else {
        set(ref(db, "users/" + userid), currentUser).then(() => {
          localStorage.setItem("chatUser", JSON.stringify(currentUser));
          document.getElementById("step2").style.display = "none";
          showHomeAfterLogin();
          try {
            set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: null });
            try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
            try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
          } catch(e) {}
        });
      }
    };

    function showHomeAfterLogin() {
      // show only Home and show a suggestion banner ‚Äî do NOT auto-open chat rooms
      showScreen("homeScreen");
      document.getElementById("defaultWhiteBox").style.display = "flex";
      suggestLastChatBanner();
    }

    async function suggestLastChatBanner() {
      ensureCurrentUserFromStorage();
      const banner = document.getElementById("continueChatBanner");
      banner.innerHTML = ""; // clear
      if (!currentUser.userid) return;
      try {
        const matesSnap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (!matesSnap.exists()) {
          banner.innerHTML = ""; // no mates, no banner
          return;
        }
        const mates = matesSnap.val();
        let latest = { ts: 0, mateId: null, mateName: null, text: "" };
        const mateList = Object.values(mates);
        for (let i = 0; i < mateList.length; i++) {
          const m = mateList[i];
          const roomId = currentUser.userid < m.userid ? currentUser.userid + "_" + m.userid : m.userid + "_" + currentUser.userid;
          const lastMsgSnap = await get(query(ref(db, "chats/" + roomId), limitToLast(1)));
          if (lastMsgSnap.exists()) {
            const val = lastMsgSnap.val();
            const keys = Object.keys(val);
            if (keys.length) {
              const key = keys[0];
              const ts = Number(key) || 0;
              const msg = val[key];
              if (ts > latest.ts) {
                latest = { ts, mateId: m.userid, mateName: m.username, text: msg.text || "" };
              }
            }
          }
        }

        if (latest.ts > 0) {
          const snippet = latest.text.length > 60 ? latest.text.slice(0, 60) + "‚Ä¶" : latest.text;
          banner.innerHTML = `
            <div class="continueBanner">
              <div style="flex:1">
                <div style="font-weight:700">üìå Continue chat with ${escapeHtml(latest.mateName)}</div>
                <div style="font-size:13px;margin-top:6px;color:#333">"${escapeHtml(snippet)}"</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button onclick="openChatRoom('${latest.mateId}','${escapeJs(latest.mateName)}')">Open</button>
                <button onclick="document.getElementById('continueChatBanner').innerHTML=''">Dismiss</button>
              </div>
            </div>
          `;
        } else {
          banner.innerHTML = ""; // no messages at all
        }
      } catch (err) {
        banner.innerHTML = "";
        console.error("suggestLastChatBanner error:", err);
      }
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }
    function escapeJs(str) { return String(str || "").replace(/'/g, "\\'"); }

function updateProfileBubble(){
      try{
        const el = document.getElementById("profileBubble");
        if(!el) return;
        if (currentUser && currentUser.photo) {
          el.innerHTML = '<img src="'+currentUser.photo+'" style="width:54px;height:54px;border-radius:50%;object-fit:cover;" />';
        } else {
          el.innerText = 'üë§';
        }
      }catch(e){}
    }

    // helper: show an editable profile form (vertical) and allow saving photo + credentials
    window.saveProfileEdits = async function(){
      try{
        const name = document.getElementById('edit_username').value.trim();
        const pass = document.getElementById('edit_password').value.trim();
        const file = document.getElementById('edit_profilePhoto').files[0];
        if(!name){ alert('Enter a username'); return; }
        currentUser.username = name;
        if(pass) currentUser.password = pass;
        if(file){
          const reader = new FileReader();
          reader.onload = async function(ev){
            currentUser.photo = ev.target.result;
            try{
              await set(ref(db, 'users/' + currentUser.userid), currentUser);
              localStorage.setItem('chatUser', JSON.stringify(currentUser));
              // propagate photo to other people's mate lists
              try{
                const matesSnap = await get(child(dbRef, 'mates/' + currentUser.userid));
                if(matesSnap.exists()){
                  const mates = matesSnap.val();
                  Object.keys(mates).forEach(mid => {
                    try{ set(ref(db, 'mates/' + mid + '/' + currentUser.userid + '/photo'), currentUser.photo); }catch(e){}
                  });
                }
              }catch(e){}
              updateProfileBubble();
              viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
              showCustomAlert('Profile saved');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save';
            }catch(e){ console.error(e); showCustomAlert('Error saving profile');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save'; }
          };
          reader.readAsDataURL(file);
        } else {
          try{
            await set(ref(db, 'users/' + currentUser.userid), currentUser);
            localStorage.setItem('chatUser', JSON.stringify(currentUser));
            updateProfileBubble();
            viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
            showCustomAlert('Profile saved');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save';
          }catch(e){ console.error(e); showCustomAlert('Error saving profile');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save'; }
        }
      }catch(e){ console.error(e); showCustomAlert('Error');
      document.querySelector('#editProfileSaveBtn').disabled=false;
      document.querySelector('#editProfileSaveBtn').innerText='Save'; }
    }

    function cancelEditProfile(){
      if(currentUser && currentUser.userid) viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
    }
        window.showMyProfile = function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid || !currentUser.username) { alert("Please complete registration"); return; }
      viewProfile(currentUser.username, currentUser.userid, currentUser.password || "");
    };

    window.searchMate = async function () {
      const mateId = document.getElementById("searchInput").value.trim();
      const resultBox = document.getElementById("searchResult");
      resultBox.innerHTML = "";
      if (!mateId) { resultBox.innerText = "Enter a User ID to search."; return; }
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { resultBox.innerText = "Please login/register first."; return; }
      try {
        const snap = await get(child(dbRef, "users/" + mateId));
        if (snap.exists()) {
          const mate = snap.val();
          resultBox.innerHTML = `
            <div class="profileCard">
              <div class="pc-left">
                ${mate.photo ? `<img src="${mate.photo}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;" />` : 'üë§'}
              </div>
              <div class="pc-body">
                <div class="pc-name">${escapeHtml(mate.username)}</div>
                <div class="pc-id">ID: ${escapeHtml(mate.userid)}</div>
                <div class="pc-actions">
                  <button onclick="makeMate('${mate.userid}','${escapeJs(mate.username)}')">‚ûï Add Mate</button>
                </div>
              </div>
            </div>
          `;
        } else resultBox.innerText = "No user found.";
      } catch (err) {
        resultBox.innerText = "Error searching mate.";
      }
    };

    window.makeMate = async function (mateId, mateName) {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      try {
        const snap = await get(child(dbRef, "users/" + mateId));
        const mate = snap.exists() ? snap.val() : null;
        const mateObj = { userid: mateId, username: mateName, photo: mate && mate.photo ? mate.photo : '' };
        await set(ref(db, "mates/" + currentUser.userid + "/" + mateId), mateObj);
        // reciprocate: include current user's photo as well
        const myObj = { userid: currentUser.userid, username: currentUser.username, photo: currentUser.photo || '' };
        await set(ref(db, "mates/" + mateId + "/" + currentUser.userid), myObj);
        document.getElementById("searchResult").innerHTML = `<div class="successMsg">Mate added successfully ‚úÖ</div>`;
      } catch(e){
        console.error(e);
        document.getElementById("searchResult").innerHTML = `<div class="successMsg">Error adding mate</div>`;
      }
    };

    window.openMatesPage = async function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("matesScreen");
      const list = document.getElementById("matesList");
      list.innerHTML = "";
      try {
        const snap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (snap.exists()) {
          const mates = snap.val();
          Object.values(mates).forEach(m => {
            if (m.userid === currentUser.userid) return; // skip self
            if (m.userid === currentUser.userid) return; // skip self
            const card = document.createElement("div");
            card.className = "mateCard";
            card.innerHTML = `
              <div class="mate-left">
                ${m.photo ? `<img src="${m.photo}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" />` : 'üë§'}
              </div>
              <div class="mate-mid">
                <div class="mname">${escapeHtml(m.username)}</div>
                <div class="mid">ID: ${escapeHtml(m.userid)}</div>
              </div>
            `;
            list.appendChild(card);
          });
        } else list.innerText = "No mates yet.";
      } catch { list.innerText = "Error loading mates."; }
    };

    window.viewProfile = function (name, id, pass) {
      showScreen("profileScreen");
      // If viewing current user -> allow edit
      let photoHtml = "üë§";
      try {
        const userData = JSON.parse(localStorage.getItem("chatUser") || "{}");
        if (userData && userData.userid === id && userData.photo) {
          photoHtml = `<img src="${userData.photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;" />`;
        } else {
          // try to load photo from users/ node
          try{
            get(child(dbRef, 'users/' + id)).then(snap => {
              if(snap.exists() && snap.val().photo) {
                document.getElementById('profileContent').querySelector('.profileBigAvatar').innerHTML = `<img src="${snap.val().photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;" />`;
              }
            });
          }catch(e){}
        }
      } catch(e){}
      // If this is own profile, show editable vertical form
      const isMine = currentUser && currentUser.userid === id;
      if(isMine){
        document.getElementById("profileContent").innerHTML = `
          <div class="profileBig" style="flex-direction:column;align-items:flex-start;">
            <div class="profileBigAvatar">${photoHtml}</div>
            <div style="width:100%;margin-top:12px;display:flex;flex-direction:column;gap:8px;">
              <label style="font-weight:700">Username</label>
              <input id="edit_username" value="${escapeHtml(name)}" style="width:100%"/>
              <label style="font-weight:700">Password</label>
              <input id="edit_password" type="text" value="${escapeHtml(pass)}" style="width:100%"/>
              <label style="font-weight:700">User ID (readonly)</label>
              <input id="edit_userid" value="${escapeHtml(id)}" readonly style="width:100%;background:#f7f7f7"/>
              <label style="font-weight:700">Change photo (optional)</label>
              <input type="file" id="edit_profilePhoto" accept="image/*" capture="environment" />
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button id="editProfileSaveBtn" onclick="(function(btn){btn.disabled=true;btn.innerText='Saving...';saveProfileEdits();})(this)">Save</button>
                <button onclick="cancelEditProfile()" style="background:#fff;color:var(--accent);border:1px solid var(--accent)">Cancel</button>
              </div>
            </div>
          </div>
        `;
      } else {
        document.getElementById("profileContent").innerHTML = `
          <div class="profileBig">
            <div class="profileBigAvatar">${photoHtml}</div>
            <div class="profileBigInfo">
              <div class="profileBigName">${escapeHtml(name)}</div>
              <div style="margin-top:6px;">ID: <span class="highlightId">${escapeHtml(id)}</span></div>
              <div style="margin-top:6px;">Password: [hidden]</div>
            </div>
          </div>
        `;
      }
    };

function resetScreens() {
      ["homeScreen","matesScreen","profileScreen","chatScreen","chatRoomsScreen"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });
    }

    // -- PRESENCE helpers --
    async function setPresenceOnline() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      try {
        set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: currentActiveRoom || null });
        try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
        try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
      } catch(e) { console.error("presence err", e); }
    }

    // -- Notifications: add and show --
    async function addNotificationForUser(toUserId, fromName, text, roomId) {
      try {
        const notifPath = "notifications/" + toUserId + "/" + Date.now();
        set(ref(db, notifPath), { from: fromName, text, roomId, ts: Date.now() });
      } catch(e){ console.error("notif add err", e); }
    }

    function showLocalPopup(notifKey, notif) {
      const popup = document.createElement("div");
      popup.className = "notifPopup";
      const time = new Date(notif.ts).toLocaleString();
      popup.innerHTML = `
        <div style="font-weight:700">${escapeHtml(notif.from)}</div>
        <div style="margin-top:6px">${escapeHtml(notif.text)}</div>
        <div style="font-size:12px;color:#666;margin-top:8px">${escapeHtml(time)}</div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button onclick="(function(){ openChatRoom('${notif.fromId || ""}','${escapeJs(notif.from)}'); this.closest('.notifPopup').remove(); })()">Open</button>
          <button onclick="this.closest('.notifPopup').remove()">Dismiss</button>
        </div>
      `;
      document.body.appendChild(popup);
      setTimeout(()=>{ try{ popup.remove(); }catch(e){} }, 6000);
    }

    // listen for notifications for current user and update bell
    function listenForNotifications() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      const notifRef = ref(db, "notifications/" + currentUser.userid);
      onChildAdded(notifRef, async (snap) => {
        const key = snap.key;
        const notif = snap.val();
        // If user is currently in the same room -> ignore and remove
        if (currentActiveRoom && notif.roomId === currentActiveRoom) {
          // remove server notification to keep DB clean
          try { remove(ref(db, "notifications/" + currentUser.userid + "/" + key)); } catch(e){}
          return;
        }
        // increment badge & add to list
        notifCache[key] = notif;
        notifCount++;
        updateBellCount();
        addNotifToBellList(key, notif);
        // show transient popup
        showTransientNotification(notif, key);
      });
    }

    function updateBellCount() {
      const el = document.getElementById("notifCount");
      el.innerText = notifCount > 0 ? String(notifCount) : "";
    }

    function addNotifToBellList(key, notif) {
      const list = document.getElementById("notifList");
      const row = document.createElement("div");
      row.className = "notifRow";
      const time = new Date(notif.ts).toLocaleString();
      // infer mateId from roomId relative to current user
      const mateId = (notif.roomId || "").split('_').find(id=>id!==currentUser.userid) || "";
      row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(notif.from)}</div><div style="font-size:13px;color:#333;margin-top:4px">${escapeHtml(notif.text)}</div><div style="font-size:11px;color:#666;margin-top:6px">${escapeHtml(time)}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button onclick="(function(){ openChatRoom('${mateId}','${escapeJs(notif.from)}'); markNotifRead('${key}'); })()">Open</button><button onclick="(function(){ markNotifRead('${key}'); })()">Dismiss</button></div>`;
      row.id = "notif_" + key;
      list.prepend(row);
    }

    function markNotifRead(key) {
      try { remove(ref(db, "notifications/" + currentUser.userid + "/" + key)); } catch(e){}
      const el = document.getElementById("notif_" + key);
      if (el) el.remove();
      if (notifCache[key]) delete notifCache[key];
      notifCount = Math.max(0, notifCount - 1);
      updateBellCount();
    }

    function clearAllNotifications() {
      try {
        remove(ref(db, "notifications/" + currentUser.userid));
      } catch(e){}
      document.getElementById("notifList").innerHTML = "";
      notifCache = {};
      notifCount = 0;
      updateBellCount();
    }

    function showTransientNotification(notif, key) {
      // create a small toast-like element
      const toast = document.createElement("div");
      toast.className = "toastNotif";
      const time = new Date(notif.ts).toLocaleString();
      toast.innerHTML = `<div style="font-weight:700">${escapeHtml(notif.from)}</div><div>${escapeHtml(notif.text)}</div><div style="font-size:11px;color:#666;margin-top:6px">${escapeHtml(time)}</div>`;
      document.body.appendChild(toast);
      // click to open
      toast.onclick = () => { openChatRoom(notif.roomId.split('_').find(id=>id!==currentUser.userid), notif.from); toast.remove(); };
      setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 5000);
    }

    async function loadNotificationsList() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      const list = document.getElementById("notifList");
      list.innerHTML = "";
      notifCache = {};
      try {
        const snap = await get(child(dbRef, "notifications/" + currentUser.userid));
        if (!snap.exists()) {
          notifCount = 0;
          updateBellCount();
          list.innerHTML = "<div style='color:#666;padding:8px'>No notifications</div>";
          return;
        }
        const data = snap.val();
        const keys = Object.keys(data).sort((a,b)=>Number(b)-Number(a));
        notifCount = keys.length;
        updateBellCount();
        keys.forEach(k => { notifCache[k] = data[k]; addNotifToBellList(k, data[k]); });
      } catch(e){
        console.error("loadNotificationsList err", e);
      }
    }

    window.openChatRoom = async function (mateId, mateName) {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("chatScreen");
      currentActiveRoom = currentUser.userid < mateId ? currentUser.userid + "_" + mateId : mateId + "_" + currentUser.userid;
      // update presence activeRoom
      try { set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: currentActiveRoom }); } catch(e) {}
      document.getElementById("chatWith").innerText = "Chatting with " + mateName;
      document.getElementById("typingIndicator").innerText = "";
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      // remove notifications for this room for current user (they are now viewing)
      try {
        const notifsSnap = await get(child(dbRef, "notifications/" + currentUser.userid));
        if (notifsSnap.exists()) {
          const notifs = notifsSnap.val();
          Object.keys(notifs).forEach(k => { if (notifs[k] && notifs[k].roomId === currentActiveRoom) remove(ref(db, "notifications/" + currentUser.userid + "/" + k)); });
        }
      } catch(e){}
      // mark this room as read for current user
      try { set(ref(db, "reads/" + currentActiveRoom + "/" + currentUser.userid), Date.now()); } catch(e){}

      // subscribe to typing indicator for this room
      try {
        const typingRef = ref(db, "typing/" + currentActiveRoom);
        onValue(typingRef, (snap) => {
          const val = snap.val() || {};
          // remove own typing
          if (val[currentUser.userid]) delete val[currentUser.userid];
          const others = Object.keys(val || {}).filter(k=>val[k]);
          const indicator = document.getElementById("typingIndicator");
          if (others.length) {
            indicator.innerText = "Typing...";
          } else {
            indicator.innerText = "";
          }
        });
      } catch(e){ console.error("typing listen err", e); }

      // load messages and subscribe
      const messagesRef = ref(db, "chats/" + currentActiveRoom);
      onChildAdded(messagesRef, async (snapshot) => {
        const msg = snapshot.val();
        const ts = msg.ts || Number(snapshot.key) || Date.now();
        const time = new Date(ts).toLocaleString();
        const div = document.createElement("div");
        const me = msg.user === currentUser.username;
        div.className = "msgRow " + (me ? "me" : "them");

        // compute ticks: check reads for this room
        let isRead = false;
        try {
          const readsSnap = await get(child(dbRef, "reads/" + currentActiveRoom));
          if (readsSnap.exists()) {
            const reads = readsSnap.val();
            // mateId is the one that's not currentUser in roomId
            const mateIdFromRoom = currentActiveRoom.split('_').find(id=>id!==currentUser.userid);
            if (reads && mateIdFromRoom && reads[mateIdFromRoom] && Number(reads[mateIdFromRoom]) >= Number(ts)) {
              isRead = true;
            }
          }
        } catch(e){}

        // show message text and ticks (for messages I sent)
        const ticksHtml = me ? `<div class="msgTicks">${ isRead ? '‚úî‚úî' : '‚úî' }</div>` : '';
        // avatar (use msg.photo if present)
        let avatarHtml = (msg.photo && msg.photo.length) ? `<img src="${msg.photo}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;" />` : 'üë§';
        if (me) {
          div.innerHTML = `<div style="display:flex;align-items:center;justify-content:flex-end;gap:8px;"><div class="msgText">${escapeHtml(msg.text)}</div><div class="msgAvatar">${avatarHtml}</div></div><div class="msgTime">${escapeHtml(time)} ${ticksHtml}</div>`;
        } else {
          div.innerHTML = `<div style="display:flex;align-items:center;gap:12px;"><div class="msgAvatar">${avatarHtml}</div><div><div class="msgText"><strong>${escapeHtml(msg.user)}</strong>: ${escapeHtml(msg.text)}</div><div class="msgTime">${escapeHtml(time)}</div></div></div>`;
        }
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      document.getElementById("sendBtn").onclick = async () => {
        const text = document.getElementById("message").value.trim();
        if (!text) return;
        const ts = Date.now();
        await set(ref(db, "chats/" + currentActiveRoom + "/" + ts), { user: currentUser.username, text, ts, photo: currentUser.photo || '' });
        document.getElementById("message").value = "";
        // after sending, check mate presence and add notification only if mate not in the same activeRoom
        try {
          const matePresenceSnap = await get(child(dbRef, "presence/" + mateId));
          const matePresence = matePresenceSnap.exists() ? matePresenceSnap.val() : null;
          if (!(matePresence && matePresence.activeRoom === currentActiveRoom)) {
            // mate not in same room -> add notification for mate
            addNotificationForUser(mateId, currentUser.username, text, currentActiveRoom);
          } else {
            // if mate is in same room, mark reads for both so ticks show as read
            try { set(ref(db, "reads/" + currentActiveRoom + "/" + currentUser.userid), Date.now()); } catch(e){}
          }
        } catch(e) { console.error("presence check err", e); }
      };
    };

    window.viewChatRooms = async function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("chatRoomsScreen");
      const list = document.getElementById("chatRoomList");
      list.innerHTML = "";
      try {
        const snap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (snap.exists()) {
          const mates = snap.val();
          Object.values(mates).forEach(m => {
            if (m.userid === currentUser.userid) return; // skip self
            const btn = document.createElement("div");
            btn.className = "roomRow";
            btn.innerHTML = `<div class="roomName">Chat with ${escapeHtml(m.username)}</div><div class="roomActions"><button onclick="openChatRoom('${m.userid}','${escapeJs(m.username)}')">Open</button></div>`;
            list.appendChild(btn);
          });
        } else list.innerText = "No chat rooms yet.";
      } catch { list.innerText = "Error loading chat rooms."; }
    };

    function checkFirebaseStatus() {
      try {
        set(ref(db, "status/test"), { ping: Date.now() });
        var el=document.getElementById("fbStatus"); if(el) el.innerText="‚úÖ Firebase Connected";
      } catch {
        var el=document.getElementById("fbStatus"); if(el) el.innerText="‚ùå Firebase Offline";
      }
    }

    // typing helpers
    function setTypingFlag(roomId, turningOn) {
      if (!roomId) return;
      try {
        set(ref(db, "typing/" + roomId + "/" + currentUser.userid), turningOn ? true : null);
      } catch(e){ console.error("setTypingFlag err", e); }
    }
    function debounceSetTyping(roomId, on) {
      if (!roomId) return;
      if (typingTimeouts[roomId]) clearTimeout(typingTimeouts[roomId]);
      setTypingFlag(roomId, on);
      typingTimeouts[roomId] = setTimeout(()=>{ setTypingFlag(roomId, false); }, 2000);
    }

    window.onload = function () {
      const saved = localStorage.getItem("chatUser");
      if (saved) {
        try {
          currentUser = JSON.parse(saved);
          document.getElementById("step1").style.display = "none";
          showHomeAfterLogin();
          try{ updateProfileBubble(); }catch(e){}
          // initialize presence & notification listener
          setPresenceOnline();
          listenForNotifications();
        } catch {}
      }
      checkFirebaseStatus();
      // Bell click to toggle dropdown and load notifications
document.getElementById("notifBell").onclick = async function (e) {
  e.stopPropagation();
  const dropdown = document.getElementById("notifDropdown");
  if (dropdown.style.display === "block") {
    dropdown.style.display = "none";
  } else {
    dropdown.style.display = "block";
    await loadNotificationsList();
  }
};
      // "mark all read" control
      document.getElementById("markAllReadBtn").onclick = function(){ clearAllNotifications(); };

      // click outside to close notif dropdown
      document.addEventListener("click", function(e){
        const dropdown = document.getElementById("notifDropdown");
        const bell = document.getElementById("notifBell");
        if (!bell.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = "none";
      });

      // typing UI hooks on message input
      const messageInput = document.getElementById("message");
      messageInput.addEventListener("input", function(){
        if (!currentActiveRoom) return;
        debounceSetTyping(currentActiveRoom, true);
      });
      messageInput.addEventListener("focus", function(){
        if (!currentActiveRoom) return;
        setTypingFlag(currentActiveRoom, true);
      });
      messageInput.addEventListener("blur", function(){
        if (!currentActiveRoom) return;
        setTypingFlag(currentActiveRoom, false);
      });
    };
  </script>

  <style>
    :root{ --accent:#ff4d88;--bg:#fff5f9;--white:#ffffff; --blue:#3b82f6; }
    body{background:var(--bg);font-family:Inter,Arial,sans-serif;margin:18px;}
    .screen{display:none;max-width:900px;margin:18px auto;background:var(--white);padding:28px;border-radius:20px;box-shadow:0 8px 25px rgba(0,0,0,0.08);position:relative;}
    h2{color:var(--accent);text-align:center;margin:8px 0 18px 0;}
    input,button{font-size:16px;border-radius:10px;border:1px solid #ddd;padding:12px;}
    button{background:var(--accent);color:white;border:none;cursor:pointer;}
    button:hover{opacity:0.95;}
    #defaultWhiteBox{display:none;border-radius:18px;padding:22px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;gap:18px;background:#fff;border:2px solid var(--accent);}
    .profileBubble{font-size:54px;cursor:pointer;}
    .mainOptions{display:flex;gap:14px;}
    .mainOptions button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;cursor:pointer;}
    .profileCard{display:flex;gap:12px;border:1px solid #f0f0f0;padding:12px;border-radius:12px;align-items:center;}
    .pc-avatar{font-size:42px;cursor:pointer;}
    .pc-name{font-weight:700;font-size:18px;color:#333;}
    .mateCard{display:flex;align-items:center;gap:12px;border:1px solid #f1f1f1;padding:12px;border-radius:12px;margin-bottom:10px;}
    .mate-left{font-size:34px;cursor:pointer;}
    .mname{font-weight:700;}
    .back-small{position:fixed;left:20px;bottom:20px;background:var(--blue);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;border:none;}
    #chatBox{border:1px solid #eee;height:320px;overflow:auto;padding:12px;border-radius:12px;background:#fafafa;}
    /* messages: darker + bigger */
    .msgRow{padding:10px;margin-bottom:10px;border-radius:12px;max-width:75%;}
    .msgRow .msgText{font-size:16px;color:#111;font-weight:600;}
    .msgRow .msgTime{font-size:12px;color:#666;margin-top:6px;display:flex;align-items:center;gap:8px;}
    .msgRow.me{background:#e6f4ff;margin-left:auto;text-align:right;}
    .msgRow.them{background:#ffffff;margin-right:auto;text-align:left;}
    .roomRow{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #f1f1f1;border-radius:10px;margin-bottom:8px;}
    .profileBig{display:flex;gap:16px;align-items:center;padding:16px;border:1px solid #f1f1f1;border-radius:12px;background:#fff;}
    .profileBigAvatar{font-size:62px;}
    .profileBigName{font-weight:800;font-size:22px;color:#333;}
    .highlightId{font-weight:700;color:var(--accent);}
    .successMsg{color:green;font-weight:600;padding:10px;}
   
    /* continue banner */
    .continueBanner{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:#fff0f6;border:1px solid rgba(255,77,136,0.2);margin:12px 0;}
    .continueBanner button{background:#fff;color:var(--accent);border:1px solid var(--accent);padding:8px 12px;border-radius:8px;}
    /* notification UI */
    #notifBell{position:fixed;top:20px;left:20px;background:#fff;border:1px solid #eee;padding:8px 10px;border-radius:999px;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
    #notifBell .icon{font-size:18px;color:var(--accent);}
    #notifCount{background:var(--accent);color:#fff;border-radius:999px;padding:4px 8px;font-size:13px;}
    #notifDropdown{position:fixed;top:64px;left:20px;width:360px;background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;display:none;box-shadow:0 8px 30px rgba(0,0,0,0.08);max-height:420px;overflow:auto;z-index:10000;}
    .notifRow{display:flex;gap:12px;padding:10px;border-bottom:1px solid #f6f6f6;}
    .toastNotif{position:fixed;right:20px;bottom:20px;background:#fff;padding:12px;border-radius:12px;border:1px solid #eee;box-shadow:0 10px 30px rgba(0,0,0,0.08);z-index:10000;cursor:pointer;}
    .notifPopup{position:fixed;right:20px;bottom:90px;background:#fff;padding:12px;border-radius:12px;border:1px solid #eee;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:10000;}
    .msgTicks{font-size:14px;color:var(--blue);font-weight:700;margin-left:6px;}
    #typingIndicator{font-size:13px;color:#666;margin-top:6px;}
  .msgAvatar img{width:36px;height:36px;border-radius:50%;object-fit:cover;} .msgAvatar{font-size:22px;}
  
/* Mobile adjustments */
@media (max-width: 600px) {
  input, button {
    font-size: 14px !important;
    padding: 8px 10px !important;
    border-radius: 8px !important;
  }
  h2 {
    font-size: 18px !important;
  }
  .mainOptions {
    flex-direction: column !important;
    gap: 10px !important;
  }
  .mainOptions button {
    width: 100% !important;
    padding: 10px !important;
  }
  #searchInput {
    width: 100% !important;
    font-size: 14px !important;
    padding: 8px !important;
  }
}

#fbStatus { display: none !important; }
</style>
</head>
<body>
  <div id="notifBell"><span class="icon">üîî</span> <span id="notifCount"></span></div>
  <div id="notifDropdown"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-weight:800">Notifications</div><button id="markAllReadBtn" style="background:#fff;color:var(--accent);border:1px solid var(--accent);padding:6px 10px;border-radius:8px">Mark all read</button></div><div id="notifList"></div></div>


  <div id="step1" class="screen" style="display:block;">
    <h2>Step 1 ‚Äî Login</h2>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <input id="username" placeholder="Username" style="width:100%" />
      <input id="password" type="text" placeholder="Password" style="width:100%" />
    </div>
    <div style="margin-top:12px;">
      <button onclick="nextStep()">Next ‚Üí</button>
    </div>
  </div>

  <div id="step2" class="screen">
    <h2>Step 2 ‚Äî Choose User ID</h2>
    <div style="display:flex;flex-direction:column;gap:8px;">
    <input id="userid" placeholder="User ID (unique)" style="width:100%" />
    <label style="font-size:13px;color:#555">Upload profile photo (optional)</label>
    <input type="file" id="profilePhoto" accept="image/*" capture="environment" style="margin-top:6px;" />
    </div>
    <div style="margin-top:12px;">
      <button onclick="finishRegister()">Finish & Go to Home</button>
    </div>
  </div>

  <div id="homeScreen" class="screen">
    <div id="defaultWhiteBox">
      <div style="display:flex;align-items:center;gap:18px;">
        <div class="profileBubble" id="profileBubble" onclick="showMyProfile()">üë§</div>
        <div style="font-weight:700;font-size:20px;color:var(--accent);">Main Options</div>
      </div>
      <div class="mainOptions">
        <button onclick="openMatesPage()">ü§ù Mates</button>
        <button onclick="viewChatRooms()">üí¨ Chat Rooms</button>
        <button onclick="searchMate()">üîç Search</button>
      </div>
    </div>

    <!-- banner area for "continue last chat" (NO auto-open) -->
    <div id="continueChatBanner"></div>

    <h2>Search your mate</h2>
    <input id="searchInput" placeholder="Enter mate UserID" />
    <div style="margin-top:10px;"><button onclick="searchMate()">Search Mate</button></div>
    <div id="searchResult" style="margin-top:12px;"></div>
  </div>

  <div id="matesScreen" class="screen">
    <h2>Your Mates</h2>
    <div id="matesList"></div>
    <button class="back-small" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="profileScreen" class="screen">
    <h2>Profile</h2>
    <div id="profileContent"></div>
    <button class="back-small" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="chatScreen" class="screen">
    <h2 id="chatWith"></h2>
    <div id="typingIndicator"></div>
    <div id="chatBox"></div>
    <div style="display:flex;gap:12px;margin-top:12px;">
      <input id="message" placeholder="Type a message..." style="flex:1;" />
      <button id="sendBtn">Send</button>
    </div>
    <button class="back-small" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="chatRoomsScreen" class="screen">
    <h2>Chat Rooms</h2>
    <div id="chatRoomList"></div>
    <button class="back-small" onclick="goBack()">‚¨Ö Back</button>
  </div>

<div id="customAlert" style="display:none;position:fixed;top:20px;right:20px;
background:#4CAF50;color:#fff;padding:14px 20px;border-radius:10px;
box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:10000;">
  ‚úÖ Profile updated successfully!
</div>
<script>
function showCustomAlert(msg){
  const box=document.getElementById("customAlert");
  box.innerText=msg;
  box.style.display="block";
  setTimeout(()=>{box.style.display="none";},3000);
}
</script>

<div id="fbStatus" style="margin:10px;font-size:14px;color:#555"></div>
</body>
</html>

