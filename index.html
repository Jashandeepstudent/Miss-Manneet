<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>No Title</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script>
  // Immediate redirect check
  (function() {
    const introSeen = localStorage.getItem('introSeen');
    if (introSeen !== 'true') {
      window.location.href = 'birthday.html';
    }
  })();
</script>
  <script type="module">
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getDatabase, ref, set, onChildAdded, get, child, query, limitToLast,
      
      onValue, onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAByLACmttf6BY6r0hEmZKYontfVqnDNpM",
      authDomain: "mndpschoolrspura.firebaseapp.com",
      projectId: "mndpschoolrspura",
      storageBucket: "mndpschoolrspura.firebasestorage.app",
      messagingSenderId: "810534224714",
      appId: "1:810534224714:web:a3055b4a6b3bca507337b3",
      measurementId: "G-2610K130EN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    const dbRef = ref(db);
    let currentUser = {};
    let screenHistory = [];
    let currentActiveRoom = null;
    let notifCount = 0;
    let notifCache = {}; // store loaded notifs
    let typingTimeouts = {};

    // Sticker emojis
    const stickers = ['ðŸ˜€','ðŸ˜‚','ðŸ˜','ðŸ¥°','ðŸ˜Ž','ðŸ¤”','ðŸ˜¢','ðŸ˜­','ðŸ˜¡','ðŸ¥³','ðŸŽ‰','â¤ï¸','ðŸ’•','ðŸ‘','ðŸ‘','ðŸ™','ðŸ”¥','âœ¨','ðŸŒŸ','â­','ðŸŽˆ','ðŸŽ','ðŸŒ¸','ðŸŒº','ðŸŒ¼','ðŸ’','ðŸ¦‹','ðŸŒˆ','â˜€ï¸','ðŸŒ™','ðŸ’«'];

    function ensureCurrentUserFromStorage() {
      if (!currentUser || !currentUser.userid) {
        try {
          const saved = localStorage.getItem("chatUser");
          if (saved) currentUser = JSON.parse(saved);
        } catch {}
      }
    }

    function showScreen(id) {
      resetScreens();
      document.getElementById(id).style.display = "block";
      // prevent duplicate consecutive entries
      if (screenHistory[screenHistory.length-1] !== id) screenHistory.push(id);
    }

    window.goBack = function() {
      if (screenHistory.length > 1) {
        screenHistory.pop();
        const prev = screenHistory[screenHistory.length - 1];
        resetScreens();
        document.getElementById(prev).style.display = "block";
      } else {
        resetScreens();
        document.getElementById("homeScreen").style.display = "block";
        screenHistory = ["homeScreen"];
      }
    }

    window.nextStep = function () {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) { alert("Fill username and password"); return; }
      currentUser.username = username;
      currentUser.password = password;
      document.getElementById("step1").style.display = "none";
      document.getElementById("step2").style.display = "block";
    };

    window.finishRegister = async function () {
      const userid = document.getElementById("userid").value.trim();
      const file = document.getElementById("profilePhoto").files[0];
      if (!userid) { alert("Enter User ID"); return; }
      currentUser.userid = userid;
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          currentUser.photo = e.target.result; // base64 string
          set(ref(db, "users/" + userid), currentUser).then(() => {
            localStorage.setItem("chatUser", JSON.stringify(currentUser));
            document.getElementById("step2").style.display = "none";
            showHomeAfterLogin();
            try{ updateProfileBubble(); }catch(e){}
            
            try {
              set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: null });
              try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
              try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
            } catch(e) {}
          });
        };
        reader.readAsDataURL(file);
      } else {
        set(ref(db, "users/" + userid), currentUser).then(() => {
          localStorage.setItem("chatUser", JSON.stringify(currentUser));
          document.getElementById("step2").style.display = "none";
          showHomeAfterLogin();
          try {
            set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: null });
            try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
            try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
          } catch(e) {}
        });
      }
    };

    function showHomeAfterLogin() {
      // show only Home and show a suggestion banner â€” do NOT auto-open chat rooms
      showScreen("homeScreen");
      document.getElementById("defaultWhiteBox").style.display = "flex";
      suggestLastChatBanner();
    }

    async function suggestLastChatBanner() {
      ensureCurrentUserFromStorage();
      const banner = document.getElementById("continueChatBanner");
      banner.innerHTML = ""; // clear
      if (!currentUser.userid) return;
      try {
        const matesSnap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (!matesSnap.exists()) {
          banner.innerHTML = ""; // no mates, no banner
          return;
        }
        const mates = matesSnap.val();
        let latest = { ts: 0, mateId: null, mateName: null, text: "" };
        const mateList = Object.values(mates);
        for (let i = 0; i < mateList.length; i++) {
          const m = mateList[i];
          const roomId = currentUser.userid < m.userid ? currentUser.userid + "_" + m.userid : m.userid + "_" + currentUser.userid;
          const lastMsgSnap = await get(query(ref(db, "chats/" + roomId), limitToLast(1)));
          if (lastMsgSnap.exists()) {
            const val = lastMsgSnap.val();
            const keys = Object.keys(val);
            if (keys.length) {
              const key = keys[0];
              const ts = Number(key) || 0;
              const msg = val[key];
              if (ts > latest.ts) {
                latest = { ts, mateId: m.userid, mateName: m.username, text: msg.text || "" };
              }
            }
          }
        }

        if (latest.ts > 0) {
          const snippet = latest.text.length > 60 ? latest.text.slice(0, 60) + "â€¦" : latest.text;
          banner.innerHTML = `
            <div class="continueBanner">
              <div style="flex:1">
                <div style="font-weight:700">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="var(--primary-pink)" style="vertical-align:middle;margin-right:4px;">
                    <path d="M16 9V4l1 0c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1l1 0v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/>
                  </svg>
                  Continue chat with ${escapeHtml(latest.mateName)}
                </div>
                <div style="font-size:13px;margin-top:6px;color:#333">"${escapeHtml(snippet)}"</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button onclick="openChatRoom('${latest.mateId}','${escapeJs(latest.mateName)}')">Open</button>
                <button onclick="document.getElementById('continueChatBanner').innerHTML=''">Dismiss</button>
              </div>
            </div>
          `;
        } else {
          banner.innerHTML = ""; // no messages at all
        }
      } catch (err) {
        banner.innerHTML = "";
        console.error("suggestLastChatBanner error:", err);
      }
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }
    function escapeJs(str) { return String(str || "").replace(/'/g, "\\'"); }

function updateProfileBubble(){
      try{
        const el = document.getElementById("profileBubble");
        if(!el) return;
        if (currentUser && currentUser.photo) {
          el.innerHTML = '<img src="'+currentUser.photo+'" style="width:48px;height:48px;border-radius:50%;object-fit:cover;" />';
        } else {
          el.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="var(--primary-pink)"><circle cx="12" cy="8" r="4"/><path d="M12 14c-6.1 0-8 3.13-8 5v3h16v-3c0-1.87-1.9-5-8-5z"/></svg>';
        }
      }catch(e){}
    }

    // helper: show an editable profile form (vertical) and allow saving photo + credentials
    window.saveProfileEdits = async function(){
      try{
        const name = document.getElementById('edit_username').value.trim();
        const pass = document.getElementById('edit_password').value.trim();
        const file = document.getElementById('edit_profilePhoto').files[0];
        if(!name){ alert('Enter a username'); return; }
        currentUser.username = name;
        if(pass) currentUser.password = pass;
        if(file){
          const reader = new FileReader();
          reader.onload = async function(ev){
            currentUser.photo = ev.target.result;
            try{
              await set(ref(db, 'users/' + currentUser.userid), currentUser);
              localStorage.setItem('chatUser', JSON.stringify(currentUser));
              // propagate photo to other people's mate lists
              try{
                const matesSnap = await get(child(dbRef, 'mates/' + currentUser.userid));
                if(matesSnap.exists()){
                  const mates = matesSnap.val();
                  Object.keys(mates).forEach(mid => {
                    try{ set(ref(db, 'mates/' + mid + '/' + currentUser.userid + '/photo'), currentUser.photo); }catch(e){}
                  });
                }
              }catch(e){}
              updateProfileBubble();
              viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
              showCustomAlert('Profile saved');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save';
            }catch(e){ console.error(e); showCustomAlert('Error saving profile');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save'; }
          };
          reader.readAsDataURL(file);
        } else {
          try{
            await set(ref(db, 'users/' + currentUser.userid), currentUser);
            localStorage.setItem('chatUser', JSON.stringify(currentUser));
            updateProfileBubble();
            viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
            showCustomAlert('Profile saved');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save';
          }catch(e){ console.error(e); showCustomAlert('Error saving profile');
              document.querySelector('#editProfileSaveBtn').disabled=false;
              document.querySelector('#editProfileSaveBtn').innerText='Save'; }
        }
      }catch(e){ console.error(e); showCustomAlert('Error');
      document.querySelector('#editProfileSaveBtn').disabled=false;
      document.querySelector('#editProfileSaveBtn').innerText='Save'; }
    }

    function cancelEditProfile(){
      if(currentUser && currentUser.userid) viewProfile(currentUser.username, currentUser.userid, currentUser.password || '');
    }
        window.showMyProfile = function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid || !currentUser.username) { alert("Please complete registration"); return; }
      viewProfile(currentUser.username, currentUser.userid, currentUser.password || "");
    };

    window.searchMate = async function () {
      const mateId = document.getElementById("searchInput").value.trim();
      const resultBox = document.getElementById("searchResult");
      resultBox.innerHTML = "";
      if (!mateId) { resultBox.innerText = "Enter a User ID to search."; return; }
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { resultBox.innerText = "Please login/register first."; return; }
      try {
        const snap = await get(child(dbRef, "users/" + mateId));
        if (snap.exists()) {
          const mate = snap.val();
          resultBox.innerHTML = `
            <div class="profileCard">
              <div class="pc-left">
                ${mate.photo ? `<img src="${mate.photo}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;" />` : '<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="var(--primary-pink)"><circle cx="12" cy="8" r="4"/><path d="M12 14c-6.1 0-8 3.13-8 5v3h16v-3c0-1.87-1.9-5-8-5z"/></svg>'}
              </div>
              <div class="pc-body">
                <div class="pc-name">${escapeHtml(mate.username)}</div>
                <div class="pc-id">ID: ${escapeHtml(mate.userid)}</div>
                <div class="pc-actions">
                  <button onclick="makeMate('${mate.userid}','${escapeJs(mate.username)}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px;">
                      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Add Mate
                  </button>
                </div>
              </div>
            </div>
          `;
        } else resultBox.innerText = "No user found.";
      } catch (err) {
        resultBox.innerText = "Error searching mate.";
      }
    };

    window.makeMate = async function (mateId, mateName) {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      try {
        const snap = await get(child(dbRef, "users/" + mateId));
        const mate = snap.exists() ? snap.val() : null;
        const mateObj = { userid: mateId, username: mateName, photo: mate && mate.photo ? mate.photo : '' };
        await set(ref(db, "mates/" + currentUser.userid + "/" + mateId), mateObj);
        // reciprocate: include current user's photo as well
        const myObj = { userid: currentUser.userid, username: currentUser.username, photo: currentUser.photo || '' };
        await set(ref(db, "mates/" + mateId + "/" + currentUser.userid), myObj);
        document.getElementById("searchResult").innerHTML = `<div class="successMsg">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="#10b981" style="vertical-align:middle;margin-right:6px;">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          Mate added successfully
        </div>`;
      } catch(e){
        console.error(e);
        document.getElementById("searchResult").innerHTML = `<div class="successMsg">Error adding mate</div>`;
      }
    };

    window.openMatesPage = async function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("matesScreen");
      const list = document.getElementById("matesList");
      list.innerHTML = "";
      try {
        const snap = await get(child(dbRef, "mates/" + currentUser.userid));
        if (snap.exists()) {
          const mates = snap.val();
          Object.values(mates).forEach(m => {
            if (m.userid === currentUser.userid) return; // skip self
            if (m.userid === currentUser.userid) return; // skip self
            const card = document.createElement("div");
            card.className = "mateCard";
            card.innerHTML = `
              <div class="mate-left">
                ${m.photo ? `<img src="${m.photo}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" />` : '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="var(--primary-pink)"><circle cx="12" cy="8" r="4"/><path d="M12 14c-6.1 0-8 3.13-8 5v3h16v-3c0-1.87-1.9-5-8-5z"/></svg>'}
              </div>
              <div class="mate-mid">
                <div class="mname">${escapeHtml(m.username)}</div>
                <div class="mid">ID: ${escapeHtml(m.userid)}</div>
              </div>
            `;
            list.appendChild(card);
          });
        } else list.innerText = "No mates yet.";
      } catch { list.innerText = "Error loading mates."; }
    };

    window.viewProfile = function (name, id, pass) {
      showScreen("profileScreen");
      // If viewing current user -> allow edit
      let photoHtml = '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="var(--primary-pink)"><circle cx="12" cy="8" r="4"/><path d="M12 14c-6.1 0-8 3.13-8 5v3h16v-3c0-1.87-1.9-5-8-5z"/></svg>';
      try {
        const userData = JSON.parse(localStorage.getItem("chatUser") || "{}");
        if (userData && userData.userid === id && userData.photo) {
          photoHtml = `<img src="${userData.photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;" />`;
        } else {
          // try to load photo from users/ node
          try{
            get(child(dbRef, 'users/' + id)).then(snap => {
              if(snap.exists() && snap.val().photo) {
                document.getElementById('profileContent').querySelector('.profileBigAvatar').innerHTML = `<img src="${snap.val().photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;" />`;
              }
            });
          }catch(e){}
        }
      } catch(e){}
      // If this is own profile, show editable vertical form
      const isMine = currentUser && currentUser.userid === id;
      if(isMine){
        document.getElementById("profileContent").innerHTML = `
          <div class="profileBig" style="flex-direction:column;align-items:flex-start;">
            <div class="profileBigAvatar">${photoHtml}</div>
            <div style="width:100%;margin-top:12px;display:flex;flex-direction:column;gap:8px;">
              <label style="font-weight:700">Username</label>
              <input id="edit_username" value="${escapeHtml(name)}" style="width:100%"/>
              <label style="font-weight:700">Password</label>
              <input id="edit_password" type="text" value="${escapeHtml(pass)}" style="width:100%"/>
              <label style="font-weight:700">User ID (readonly)</label>
              <input id="edit_userid" value="${escapeHtml(id)}" readonly style="width:100%;background:#f7f7f7"/>
              <label style="font-weight:700">Change photo (optional)</label>
              <input type="file" id="edit_profilePhoto" accept="image/*" capture="environment" />
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button id="editProfileSaveBtn" onclick="(function(btn){btn.disabled=true;btn.innerText='Saving...';saveProfileEdits();})(this)">Save</button>
                <button onclick="cancelEditProfile()" style="background:#fff;color:var(--accent);border:1px solid var(--accent)">Cancel</button>
              </div>
            </div>
          </div>
        `;
      } else {
        document.getElementById("profileContent").innerHTML = `
          <div class="profileBig">
            <div class="profileBigAvatar">${photoHtml}</div>
            <div class="profileBigInfo">
              <div class="profileBigName">${escapeHtml(name)}</div>
              <div style="margin-top:6px;">ID: <span class="highlightId">${escapeHtml(id)}</span></div>
              <div style="margin-top:6px;">Password: [hidden]</div>
            </div>
          </div>
        `;
      }
    };

function resetScreens() {
      ["homeScreen","matesScreen","profileScreen","chatScreen","chatRoomsScreen"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });
    }

    // -- PRESENCE helpers --
    async function setPresenceOnline() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      try {
        set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: currentActiveRoom || null });
        try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/online")).set(false); } catch(e) {}
        try { onDisconnect(ref(db, "presence/" + currentUser.userid + "/activeRoom")).remove(); } catch(e) {}
      } catch(e) { console.error("presence err", e); }
    }

    // -- Notifications: add and show --
    async function addNotificationForUser(toUserId, fromName, text, roomId) {
      try {
        const notifPath = "notifications/" + toUserId + "/" + Date.now();
        set(ref(db, notifPath), { from: fromName, text, roomId, ts: Date.now() });
      } catch(e){ console.error("notif add err", e); }
    }

    function showLocalPopup(notifKey, notif) {
      const popup = document.createElement("div");
      popup.className = "notifPopup";
      const time = new Date(notif.ts).toLocaleString();
      popup.innerHTML = `
        <div style="font-weight:700">${escapeHtml(notif.from)}</div>
        <div style="margin-top:6px">${escapeHtml(notif.text)}</div>
        <div style="font-size:12px;color:#666;margin-top:8px">${escapeHtml(time)}</div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button onclick="(function(){ openChatRoom('${notif.fromId || ""}','${escapeJs(notif.from)}'); this.closest('.notifPopup').remove(); })()">Open</button>
          <button onclick="this.closest('.notifPopup').remove()">Dismiss</button>
        </div>
      `;
      document.body.appendChild(popup);
      setTimeout(()=>{ try{ popup.remove(); }catch(e){} }, 6000);
    }

    // listen for notifications for current user and update bell
    function listenForNotifications() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      const notifRef = ref(db, "notifications/" + currentUser.userid);
      onChildAdded(notifRef, async (snap) => {
        const key = snap.key;
        const notif = snap.val();
        // If user is currently in the same room -> ignore and remove
        if (currentActiveRoom && notif.roomId === currentActiveRoom) {
          // remove server notification to keep DB clean
          try { remove(ref(db, "notifications/" + currentUser.userid + "/" + key)); } catch(e){}
          return;
        }
        // increment badge & add to list
        notifCache[key] = notif;
        notifCount++;
        updateBellCount();
        addNotifToBellList(key, notif);
        // show transient popup
        showTransientNotification(notif, key);
      });
    }

    function updateBellCount() {
      const el = document.getElementById("notifCount");
      el.innerText = notifCount > 0 ? String(notifCount) : "";
    }

    function addNotifToBellList(key, notif) {
      const list = document.getElementById("notifList");
      const row = document.createElement("div");
      row.className = "notifRow";
      const time = new Date(notif.ts).toLocaleString();
      // infer mateId from roomId relative to current user
      const mateId = (notif.roomId || "").split('_').find(id=>id!==currentUser.userid) || "";
      row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(notif.from)}</div><div style="font-size:13px;color:#333;margin-top:4px">${escapeHtml(notif.text)}</div><div style="font-size:11px;color:#666;margin-top:6px">${escapeHtml(time)}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button onclick="(function(){ openChatRoom('${mateId}','${escapeJs(notif.from)}'); markNotifRead('${key}'); })()">Open</button><button onclick="markNotifRead('${key}')">Dismiss</button></div>`;
      row.id = "notif_" + key;
      list.prepend(row);
    }

    function markNotifRead(key) {
      try { remove(ref(db, "notifications/" + currentUser.userid + "/" + key)); } catch(e){}
      const el = document.getElementById("notif_" + key);
      if (el) el.remove();
      if (notifCache[key]) delete notifCache[key];
      notifCount = Math.max(0, notifCount - 1);
      updateBellCount();
    }

    function clearAllNotifications() {
      try {
        remove(ref(db, "notifications/" + currentUser.userid));
      } catch(e){}
      document.getElementById("notifList").innerHTML = "";
      notifCache = {};
      notifCount = 0;
      updateBellCount();
    }

    function showTransientNotification(notif, key) {
      // create a small toast-like element
      const toast = document.createElement("div");
      toast.className = "toastNotif";
      const time = new Date(notif.ts).toLocaleString();
      toast.innerHTML = `<div style="font-weight:700">${escapeHtml(notif.from)}</div><div>${escapeHtml(notif.text)}</div><div style="font-size:11px;color:#666;margin-top:6px">${escapeHtml(time)}</div>`;
      document.body.appendChild(toast);
      // click to open
      toast.onclick = () => { openChatRoom(notif.roomId.split('_').find(id=>id!==currentUser.userid), notif.from); toast.remove(); };
      setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 5000);
    }

    async function loadNotificationsList() {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) return;
      const list = document.getElementById("notifList");
      list.innerHTML = "";
      notifCache = {};
      try {
        const snap = await get(child(dbRef, "notifications/" + currentUser.userid));
        if (!snap.exists()) {
          notifCount = 0;
          updateBellCount();
          list.innerHTML = "<div style='color:#666;padding:8px'>No notifications</div>";
          return;
        }
        const data = snap.val();
        const keys = Object.keys(data).sort((a,b)=>Number(b)-Number(a));
        notifCount = keys.length;
        updateBellCount();
        keys.forEach(k => { notifCache[k] = data[k]; addNotifToBellList(k, data[k]); });
      } catch(e){
        console.error("loadNotificationsList err", e);
      }
    }

    // Photo attachment helpers
    window.triggerPhotoChoose = function() {
      document.getElementById('photoInput').click();
    }

    window.handlePhotoSelect = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        const photoData = e.target.result;
        await sendMessageWithPhoto(photoData);
      };
      reader.readAsDataURL(file);
    }

    window.openPhotoViewer = function(photoSrc) {
      const viewer = document.getElementById('photoViewer');
      const img = viewer.querySelector('img');
      img.src = photoSrc;
      viewer.style.display = 'flex';
    }

    window.closePhotoViewer = function() {
      document.getElementById('photoViewer').style.display = 'none';
    }

    async function sendMessageWithPhoto(photoData) {
      if (!currentActiveRoom) return;
      const ts = Date.now();
      await set(ref(db, "chats/" + currentActiveRoom + "/" + ts), { 
        user: currentUser.username, 
        text: '', 
        photo: currentUser.photo || '',
        imageData: photoData, 
        ts 
      });
      // notification logic
      const mateId = currentActiveRoom.split('_').find(id=>id!==currentUser.userid);
      try {
        const matePresenceSnap = await get(child(dbRef, "presence/" + mateId));
        const matePresence = matePresenceSnap.exists() ? matePresenceSnap.val() : null;
        if (!(matePresence && matePresence.activeRoom === currentActiveRoom)) {
          addNotificationForUser(mateId, currentUser.username, 'ðŸ“· Photo', currentActiveRoom);
        }
      } catch(e) {}
    }

    // Sticker helpers
    window.toggleStickerPicker = function() {
      const picker = document.getElementById('stickerPicker');
      picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
    }

    window.sendSticker = async function(sticker) {
      if (!currentActiveRoom) return;
      const ts = Date.now();
      await set(ref(db, "chats/" + currentActiveRoom + "/" + ts), { 
        user: currentUser.username, 
        text: sticker, 
        photo: currentUser.photo || '',
        isSticker: true,
        ts 
      });
      document.getElementById('stickerPicker').style.display = 'none';
      // notification
      const mateId = currentActiveRoom.split('_').find(id=>id!==currentUser.userid);
      try {
        const matePresenceSnap = await get(child(dbRef, "presence/" + mateId));
        const matePresence = matePresenceSnap.exists() ? matePresenceSnap.val() : null;
        if (!(matePresence && matePresence.activeRoom === currentActiveRoom)) {
          addNotificationForUser(mateId, currentUser.username, sticker, currentActiveRoom);
        }
      } catch(e) {}
    }

    window.openChatRoom = async function (mateId, mateName) {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      showScreen("chatScreen");
      currentActiveRoom = currentUser.userid < mateId ? currentUser.userid + "_" + mateId : mateId + "_" + currentUser.userid;
      // update presence activeRoom
      try { set(ref(db, "presence/" + currentUser.userid), { online: true, lastSeen: Date.now(), activeRoom: currentActiveRoom }); } catch(e) {}
      document.getElementById("chatWith").innerText = mateName;
      document.getElementById("typingIndicator").innerText = "";
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      // remove notifications for this room for current user (they are now viewing)
      try {
        const notifsSnap = await get(child(dbRef, "notifications/" + currentUser.userid));
        if (notifsSnap.exists()) {
          const notifs = notifsSnap.val();
          Object.keys(notifs).forEach(k => { if (notifs[k] && notifs[k].roomId === currentActiveRoom) remove(ref(db, "notifications/" + currentUser.userid + "/" + k)); });
        }
      } catch(e){}
      // mark this room as read for current user
      try { set(ref(db, "reads/" + currentActiveRoom + "/" + currentUser.userid), Date.now()); } catch(e){}

      // subscribe to typing indicator for this room
      try {
        const typingRef = ref(db, "typing/" + currentActiveRoom);
        onValue(typingRef, (snap) => {
          const val = snap.val() || {};
          // remove own typing
          if (val[currentUser.userid]) delete val[currentUser.userid];
          const others = Object.keys(val || {}).filter(k=>val[k]);
          const indicator = document.getElementById("typingIndicator");
          if (others.length) {
            indicator.innerText = "typing...";
          } else {
            indicator.innerText = "";
          }
        });
      } catch(e){ console.error("typing listen err", e); }

      // load messages and subscribe
      const messagesRef = ref(db, "chats/" + currentActiveRoom);
      onChildAdded(messagesRef, async (snapshot) => {
        const msg = snapshot.val();
        const ts = msg.ts || Number(snapshot.key) || Date.now();
        const time = new Date(ts).toLocaleString();
        const div = document.createElement("div");
        const me = msg.user === currentUser.username;
        div.className = "msgRow " + (me ? "me" : "them");

        // compute ticks: check reads for this room
        let isRead = false;
        try {
          const readsSnap = await get(child(dbRef, "reads/" + currentActiveRoom));
          if (readsSnap.exists()) {
            const reads = readsSnap.val();
            // mateId is the one that's not currentUser in roomId
            const mateIdFromRoom = currentActiveRoom.split('_').find(id=>id!==currentUser.userid);
            if (reads && mateIdFromRoom && reads[mateIdFromRoom] && Number(reads[mateIdFromRoom]) >= Number(ts)) {
              isRead = true;
            }
          }
        } catch(e){}

        // avatar (use msg.photo if present)
        let avatarHtml = (msg.photo && msg.photo.length) ? `<img src="${msg.photo}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;" />` : '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="var(--primary-pink)"><circle cx="12" cy="8" r="4"/><path d="M12 14c-6.1 0-8 3.13-8 5v3h16v-3c0-1.87-1.9-5-8-5z"/></svg>';
        
        // Check if message has image
        let contentHtml = '';
        let bubbleClass = '';
        if (msg.imageData) {
          bubbleClass = ' photo';
          contentHtml = `<img src="${msg.imageData}" style="max-width:250px;max-height:250px;border-radius:10px;cursor:pointer;display:block;" onclick="openPhotoViewer('${msg.imageData}')" />`;
        } else if (msg.isSticker) {
          contentHtml = `<div style="font-size:48px;">${escapeHtml(msg.text)}</div>`;
        } else {
          contentHtml = `<div style="word-wrap:break-word;word-break:break-word;white-space:pre-wrap;">${escapeHtml(msg.text)}</div>`;
        }

        const ticksHtml = me ? `<div class="msgTicks">${ isRead ? 'âœ”âœ”' : 'âœ”' }</div>` : '';
        
        if (me) {
          div.innerHTML = `<div style="display:flex;align-items:flex-end;justify-content:flex-end;gap:8px;"><div class="msgBubble${bubbleClass}">${contentHtml}</div><div class="msgAvatar">${avatarHtml}</div></div><div class="msgTime">${escapeHtml(time)} ${ticksHtml}</div>`;
        } else {
          div.innerHTML = `<div style="display:flex;align-items:flex-end;gap:8px;"><div class="msgAvatar">${avatarHtml}</div><div><div class="msgBubble${bubbleClass}"><div style="font-weight:700;margin-bottom:4px;font-size:13px;">${escapeHtml(msg.user)}</div>${contentHtml}</div><div class="msgTime">${escapeHtml(time)}</div></div></div>`;
        }
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      document.getElementById("sendBtn").onclick = async () => {
        const text = document.getElementById("message").value.trim();
        if (!text) return;
        const ts = Date.now();
        await set(ref(db, "chats/" + currentActiveRoom + "/" + ts), { user: currentUser.username, text, ts, photo: currentUser.photo || '' });
        document.getElementById("message").value = "";
        // after sending, check mate presence and add notification only if mate not in the same activeRoom
        try {
          const matePresenceSnap = await get(child(dbRef, "presence/" + mateId));
          const matePresence = matePresenceSnap.exists() ? matePresenceSnap.val() : null;
          if (!(matePresence && matePresence.activeRoom === currentActiveRoom)) {
            // mate not in same room -> add notification for mate
            addNotificationForUser(mateId, currentUser.username, text, currentActiveRoom);
          } else {
            // if mate is in same room, mark reads for both so ticks show as read
            try { set(ref(db, "reads/" + currentActiveRoom + "/" + currentUser.userid), Date.now()); } catch(e){}
          }
        } catch(e) { console.error("presence check err", e); }
      };
    };

    window.viewChatRooms = async function () {
      ensureCurrentUserFromStorage();
      if (!currentUser.userid) { alert("Login first"); return; }
      
      // Show waving animation
      const waveAnim = document.getElementById('waveAnimation');
      const waveText = waveAnim.querySelector('.wave-text');
      waveText.innerHTML = `Hi there ${escapeHtml(currentUser.username)}!`;
      waveAnim.style.display = 'flex';
      
      setTimeout(() => {
        waveAnim.style.display = 'none';
        // Now show the chat rooms screen
        showScreen("chatRoomsScreen");
        const list = document.getElementById("chatRoomList");
        list.innerHTML = "";
        get(child(dbRef, "mates/" + currentUser.userid)).then(snap => {
          if (snap.exists()) {
            const mates = snap.val();
            Object.values(mates).forEach(m => {
              if (m.userid === currentUser.userid) return; // skip self
              const btn = document.createElement("div");
              btn.className = "roomRow";
              btn.innerHTML = `<div class="roomAvatar">${m.photo ? `<img src="${m.photo}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" />` : '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="var(--primary-pink)"><circle cx="12" cy="8" r="4"/><path d="M12 14c-6.1 0-8 3.13-8 5v3h16v-3c0-1.87-1.9-5-8-5z"/></svg>'}</div><div class="roomName">${escapeHtml(m.username)}</div><div class="roomActions"><button onclick="openChatRoom('${m.userid}','${escapeJs(m.username)}')">Open</button></div>`;
              list.appendChild(btn);
            });
          } else list.innerText = "No chat rooms yet.";
        }).catch(() => { list.innerText = "Error loading chat rooms."; });
      }, 2000);
    };

    function checkFirebaseStatus() {
      try {
        set(ref(db, "status/test"), { ping: Date.now() });
        var el=document.getElementById("fbStatus"); if(el) el.innerText="âœ… Firebase Connected";
      } catch {
        var el=document.getElementById("fbStatus"); if(el) el.innerText="âŒ Firebase Offline";
      }
    }

    // typing helpers
    function setTypingFlag(roomId, turningOn) {
      if (!roomId) return;
      try {
        set(ref(db, "typing/" + roomId + "/" + currentUser.userid), turningOn ? true : null);
      } catch(e){ console.error("setTypingFlag err", e); }
    }
    function debounceSetTyping(roomId, on) {
      if (!roomId) return;
      if (typingTimeouts[roomId]) clearTimeout(typingTimeouts[roomId]);
      setTypingFlag(roomId, on);
      typingTimeouts[roomId] = setTimeout(()=>{ setTypingFlag(roomId, false); }, 2000);
    }

    window.onload = function () {
      const saved = localStorage.getItem("chatUser");
      if (saved) {
        try {
          currentUser = JSON.parse(saved);
          document.getElementById("step1").style.display = "none";
          showHomeAfterLogin();
          try{ updateProfileBubble(); }catch(e){}
          // initialize presence & notification listener
          setPresenceOnline();
          listenForNotifications();
        } catch {}
      }
      checkFirebaseStatus();
      
      // Populate sticker picker
      const stickerGrid = document.getElementById('stickerGrid');
      stickers.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'stickerBtn';
        btn.innerText = s;
        btn.onclick = () => sendSticker(s);
        stickerGrid.appendChild(btn);
      });

      // Bell click to toggle dropdown and load notifications
      document.getElementById("notifBell").onclick = async function (e) {
        e.stopPropagation();
        const dropdown = document.getElementById("notifDropdown");
        if (dropdown.style.display === "block") {
          dropdown.style.display = "none";
        } else {
          dropdown.style.display = "block";
          await loadNotificationsList();
        }
      };
      // "mark all read" control
      document.getElementById("markAllReadBtn").onclick = function(){ clearAllNotifications(); };

      // click outside to close notif dropdown
      document.addEventListener("click", function(e){
        const dropdown = document.getElementById("notifDropdown");
        const bell = document.getElementById("notifBell");
        if (!bell.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = "none";
      });

      // typing UI hooks on message input
      const messageInput = document.getElementById("message");
      messageInput.addEventListener("input", function(){
        if (!currentActiveRoom) return;
        debounceSetTyping(currentActiveRoom, true);
      });
      messageInput.addEventListener("focus", function(){
        if (!currentActiveRoom) return;
        setTypingFlag(currentActiveRoom, true);
      });
      messageInput.addEventListener("blur", function(){
        if (!currentActiveRoom) return;
        setTypingFlag(currentActiveRoom, false);
      });
    };
  </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{ 
      --primary-pink:#ff4d88;
      --light-pink:#fff0f6;
      --lighter-pink:#fff5f9;
      --white:#ffffff; 
      --blue:#3b82f6;
      --gray:#666;
      --light-gray:#f5f5f5;
    }
    
    body{
      background: linear-gradient(135deg, var(--lighter-pink) 0%, #ffe8f0 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    .screen{
      display:none;
      max-width:900px;
      margin:20px auto;
      background:var(--white);
      padding:24px;
      border-radius:24px;
      box-shadow:0 10px 40px rgba(255,77,136,0.15);
      position:relative;
    }
    .screen#chatScreen{
      display:none;
    }
    h2{
      color:var(--primary-pink);
      text-align:center;
      margin:0 0 20px 0;
      font-size:24px;
      font-weight:700;
    }
    input,button{
      font-size:15px;
      border-radius:12px;
      border:1px solid #e5e5e5;
      padding:12px 16px;
      font-family: inherit;
    }
    input:focus{
      outline: none;
      border-color: var(--primary-pink);
      box-shadow: 0 0 0 3px rgba(255,77,136,0.1);
    }
    button{
      background:var(--primary-pink);
      color:white;
      border:none;
      cursor:pointer;
      font-weight:600;
      transition: all 0.3s ease;
    }
    button:hover{
      background:#ff2d6f;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255,77,136,0.3);
    }
    button:active{
      transform: translateY(0);
    }
    #defaultWhiteBox{
      display:none;
      border-radius:20px;
      padding:16px;
      margin-bottom:16px;
      background:linear-gradient(135deg, var(--white) 0%, var(--light-pink) 100%);
      border:2px solid var(--primary-pink);
      box-shadow: 0 4px 15px rgba(255,77,136,0.1);
    }
    .profileBubble{
      font-size:48px;
      cursor:pointer;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .profileBubble svg{
      display: block;
    }
    .profileBubble:hover{
      transform: scale(1.1);
    }
    .mainOptions{
      display:flex;
      gap:6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .mainOptions button{
      padding:8px 16px;
      border-radius:20px;
      font-size: 13px;
      font-weight: 600;
      min-width: auto;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(255,77,136,0.15);
    }
    .mainOptions button svg{
      width: 16px;
      height: 16px;
    }
    .mainOptions button:hover{
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255,77,136,0.25);
    }
    .profileCard{
      display:flex;
      gap:16px;
      border:2px solid var(--light-pink);
      padding:16px;
      border-radius:16px;
      align-items:center;
      background: var(--white);
      transition: all 0.3s ease;
    }
    .profileCard:hover{
      border-color: var(--primary-pink);
      box-shadow: 0 6px 20px rgba(255,77,136,0.15);
    }
    .pc-name{
      font-weight:700;
      font-size:18px;
      color:#222;
    }
    .pc-id{
      color: var(--gray);
      margin-top: 4px;
      font-size: 14px;
    }
    .mateCard{
      display:flex;
      align-items:center;
      gap:14px;
      border:2px solid var(--light-pink);
      padding:14px;
      border-radius:16px;
      margin-bottom:12px;
      background: var(--white);
      transition: all 0.3s ease;
    }
    .mateCard:hover{
      border-color: var(--primary-pink);
      transform: translateX(4px);
    }
    .mname{
      font-weight:700;
      font-size: 16px;
    }
    .mid{
      color: var(--gray);
      font-size: 13px;
      margin-top: 2px;
    }
.back-small{
  position:absolute;
  top:10px;
  left:10px;
  background:var(--blue);
  color:#fff;
  padding:8px 16px;
  border-radius:20px;
  cursor:pointer;
  border:none;
  box-shadow: 0 4px 12px rgba(59,130,246,0.3);
  font-weight: 600;
  z-index: 1000;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  width: auto;
  white-space: nowrap;
}
    .back-small svg{
      width: 16px;
      height: 16px;
      fill: white;
    }
    #chatBox{
      border:2px solid var(--light-pink);
      height:calc(100vh - 280px);
      overflow-y:auto;
      overflow-x:hidden;
      padding:16px;
      border-radius:16px;
      background: var(--lighter-pink);
      margin-bottom: 12px;
      touch-action: pan-y;
    }
    
    /* Improved message bubbles */
    .msgRow{
      padding:8px 0;
      margin-bottom:12px;
      display: flex;
      flex-direction: column;
    }
    .msgBubble{
      padding:12px 16px;
      border-radius:18px;
      max-width:70%;
      font-size:15px;
      line-height: 1.4;
      word-wrap: break-word;
      word-break: break-word;
      white-space: pre-wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .msgBubble.photo{
      padding: 4px;
      max-width: 80%;
    }
    .msgBubble img{
      display: block;
      width: 100%;
      height: auto;
    }
    .msgRow.me .msgBubble{
      background: linear-gradient(135deg, var(--primary-pink) 0%, #ff6b9d 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .msgRow.them .msgBubble{
      background: var(--white);
      color: #222;
      border-bottom-left-radius: 4px;
      border: 1px solid var(--light-pink);
    }
    .msgRow .msgTime{
      font-size:11px;
      color: var(--gray);
      margin-top:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .msgRow.me{
      align-items: flex-end;
    }
    .msgRow.them{
      align-items: flex-start;
    }
    
    .roomRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px;
      border:2px solid var(--light-pink);
      border-radius:16px;
      margin-bottom:12px;
      background: var(--white);
      transition: all 0.3s ease;
    }
    .roomRow:hover{
      border-color: var(--primary-pink);
      box-shadow: 0 6px 20px rgba(255,77,136,0.15);
    }
    .roomAvatar{
      margin-right: 12px;
    }
    .roomName{
      flex: 1;
      font-weight: 600;
      font-size: 16px;
    }
    .profileBig{
      display:flex;
      gap:20px;
      align-items:center;
      padding:20px;
      border:2px solid var(--light-pink);
      border-radius:16px;
      background: var(--white);
    }
    .profileBigAvatar{
      font-size:80px;
    }
    .profileBigName{
      font-weight:800;
      font-size:24px;
      color:#222;
    }
    .highlightId{
      font-weight:700;
      color:var(--primary-pink);
    }
    .successMsg{
      color:#10b981;
      font-weight:600;
      padding:12px;
      background: #ecfdf5;
      border-radius: 12px;
      border: 1px solid #10b981;
    }
   
    /* continue banner */
    .continueBanner{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--white) 0%, var(--light-pink) 100%);
      border:2px solid var(--primary-pink);
      margin:12px 0;
      box-shadow: 0 4px 15px rgba(255,77,136,0.1);
    }
    .continueBanner button{
      background:var(--white);
      color:var(--primary-pink);
      border:2px solid var(--primary-pink);
      padding:6px 12px;
      border-radius:8px;
      font-size: 13px;
    }
    
    /* notification UI */
    #notifBell{
      position:fixed;
      top:16px;
      right:16px;
      z-index:20000;
      background:var(--white);
      border:2px solid var(--light-pink);
      padding:10px 14px;
      border-radius:50px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 6px 20px rgba(255,77,136,0.15);
      transition: all 0.3s ease;
    }
    #notifBell:hover{
      box-shadow:0 8px 25px rgba(255,77,136,0.25);
      transform: translateY(-2px);
    }
#chatRoomList{
  max-height: calc(100vh - 200px);
  overflow-y: scroll;
  -webkit-overflow-scrolling: touch;
  padding-right: 4px;
}
#matesList{
  max-height: calc(100vh - 200px);
  overflow-y: scroll;
  -webkit-overflow-scrolling: touch;
  padding-right: 4px;
}
    #notifBell .icon{
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #notifBell .icon svg{
      display: block;
    }
    #notifCount{
      background:var(--primary-pink);
      color:#fff;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      font-weight: 700;
    }
    #notifDropdown{
      position:fixed;
      top:80px;
      right:20px;
      width:360px;
      background:var(--white);
      border:2px solid var(--light-pink);
      border-radius:16px;
      padding:16px;
      display:none;
      box-shadow:0 10px 40px rgba(255,77,136,0.2);
      max-height:450px;
      overflow-y:auto;
      z-index:10000;
    }
    .notifRow{
      display:flex;
      gap:12px;
      padding:12px;
      border-bottom:1px solid var(--light-pink);
      transition: background 0.2s ease;
    }
    .notifRow:hover{
      background: var(--lighter-pink);
    }
    .toastNotif{
      position:fixed;
      right:20px;
      bottom:20px;
      background:var(--white);
      padding:16px;
      border-radius:16px;
      border:2px solid var(--primary-pink);
      box-shadow:0 10px 40px rgba(255,77,136,0.2);
      z-index:10000;
      cursor:pointer;
      max-width: 300px;
    }
    .notifPopup{
      position:fixed;
      right:20px;
      bottom:100px;
      background:var(--white);
      padding:16px;
      border-radius:16px;
      border:2px solid var(--primary-pink);
      box-shadow:0 10px 40px rgba(255,77,136,0.25);
      z-index:10000;
      max-width: 300px;
    }
    .msgTicks{
      font-size:12px;
      color:#fff;
      font-weight:700;
      margin-left:4px;
    }
    #typingIndicator{
      font-size:13px;
      color:var(--gray);
      margin-bottom:8px;
      font-style: italic;
      height: 18px;
    }
    .msgAvatar{
      font-size:36px;
      flex-shrink: 0;
    }
    
    /* Photo and sticker controls */
    .chatInputControls{
      display: flex;
      gap: 8px;
      margin-top: 12px;
      align-items: center;
    }
    .chatInputControls input{
      flex: 1;
    }
    .iconBtn{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--white);
      border: 2px solid var(--light-pink);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      padding: 0;
    }
    .iconBtn:hover{
      background: var(--light-pink);
      border-color: var(--primary-pink);
      transform: translateY(-2px);
    }
    .iconBtn svg{
      width: 22px;
      height: 22px;
      fill: var(--primary-pink);
    }
    #photoInput{
      display: none;
    }
    #stickerPicker{
      position: absolute;
      bottom: 70px;
      right: 20px;
      background: var(--white);
      border: 2px solid var(--primary-pink);
      border-radius: 16px;
      padding: 12px;
      display: none;
      flex-wrap: wrap;
      gap: 8px;
      width: 280px;
      max-height: 240px;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(255,77,136,0.2);
      z-index: 100;
    }
    .stickerBtn{
      width: 48px;
      height: 48px;
      font-size: 28px;
      background: var(--lighter-pink);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0;
    }
    .stickerBtn:hover{
      background: var(--light-pink);
      transform: scale(1.15);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      body{
        padding: 0;
        margin: 0;
        overflow: hidden;
      }
.screen{
  margin: 0;
  padding: 16px;
  border-radius: 0;
  height: 100vh;
  max-width: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
#chatRoomList, #matesList{
  max-height: calc(100vh - 180px);
  overflow-y: scroll;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  padding-bottom: 20px;
}
      #chatScreen{
        padding: 60px 16px 16px 16px;
      }
      h2{
        font-size: 20px;
        margin-top: 8px;
      }
      input, button{
        font-size: 14px;
        padding: 10px 14px;
      }
      .mainOptions{
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      .mainOptions button{
        padding: 5px 10px;
        font-size: 10px;
        flex: 0 0 auto;
      }
      #defaultWhiteBox{
        padding: 14px;
      }
#defaultWhiteBox > div:first-child{
  flex-direction: row !important;
  align-items: center !important;
  justify-content: space-between !important;
  gap: 10px !important;
}
#defaultWhiteBox .profileBubble{
  font-size: 40px;
  flex-shrink: 0;
}
#defaultWhiteBox .mainOptions{
  flex: 1;
  justify-content: flex-end;
}
      .profileBubble{
        font-size: 42px;
      }
      #chatBox{
        height: calc(100vh - 240px);
        min-height: 250px;
      }
      .msgBubble{
        max-width: 85%;
        font-size: 14px;
      }
      #notifDropdown{
        width: calc(100vw - 40px);
        left: auto;
        right: 20px;
      }
      #stickerPicker{
        width: calc(100vw - 40px);
        right: 20px;
        left: 20px;
      }
.back-small{
  left: 10px;
  top: 10px;
  transform: none;
  padding: 8px 12px;
  font-size: 13px;
  gap: 3px;
  max-width: 80px;
}
.back-small svg{
  width: 14px;
  height: 14px;
}
      .chatInputControls{
        flex-wrap: wrap;
      }
      .chatInputControls input{
        width: 100%;
      }
      .iconBtn{
        width: 40px;
        height: 40px;
      }
    }

    #fbStatus { display: none !important; }
    
    /* Waving Hand Animation */
  #waveAnimation{
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--lighter-pink) 0%, #ffe8f0 100%);
  z-index: 99999;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 40px;
}

.wave-container{
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.wave-hand{
  animation: wave 1.2s ease-in-out infinite;
  transform-origin: 50% 85%;
  filter: drop-shadow(0 8px 16px rgba(255,77,136,0.2));
}

@keyframes wave {
  0%, 100% { transform: rotate(0deg); }
  10% { transform: rotate(14deg); }
  20% { transform: rotate(-10deg); }
  30% { transform: rotate(14deg); }
  40% { transform: rotate(-8deg); }
  50% { transform: rotate(10deg); }
  60% { transform: rotate(0deg); }
}

.sparkle{
  position: absolute;
  animation: sparkle 2s ease-in-out infinite;
}

.sparkle-1{
  top: 10%;
  right: 15%;
  animation-delay: 0s;
}

.sparkle-2{
  bottom: 20%;
  left: 10%;
  animation-delay: 0.7s;
}

.sparkle-3{
  top: 30%;
  left: 5%;
  animation-delay: 1.4s;
}

@keyframes sparkle {
  0%, 100% { 
    opacity: 0;
    transform: scale(0) rotate(0deg);
  }
  50% { 
    opacity: 1;
    transform: scale(1) rotate(180deg);
  }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.wave-text{
  font-size: 28px;
  font-weight: 700;
  color: var(--primary-pink);
  text-align: center;
  animation: fadeIn 0.8s ease-out;
  text-shadow: 0 2px 10px rgba(255,77,136,0.3);
}

@media (max-width: 768px) {
  .wave-hand{
    width: 120px;
    height: 120px;
  }
  .wave-text{
    font-size: 24px;
    padding: 0 20px;
  }
}
    
    /* Fullscreen Photo Viewer */
    #photoViewer{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #photoViewer img{
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    #photoViewerClose{
      position: absolute;
      top: 20px;
      left: 20px;
      background: var(--white);
      color: var(--primary-pink);
      border: none;
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 100000;
    }
  </style>
</head>
<body>
  <div id="notifBell">
    <span class="icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="var(--primary-pink)">
        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
      </svg>
    </span>
    <span id="notifCount"></span>
  </div>
  
 <!-- Waving Hand Animation -->
<div id="waveAnimation">
  <div class="wave-container">
    <svg class="wave-hand" width="140" height="140" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="skinGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#FFDAB3;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#FFC896;stop-opacity:1" />
        </linearGradient>
        <filter id="handShadow">
          <feDropShadow dx="0" dy="4" stdDeviation="3" flood-opacity="0.2"/>
        </filter>
      </defs>
      
      <g filter="url(#handShadow)">
        <!-- Wrist -->
        <rect x="35" y="75" width="30" height="15" rx="7" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        
        <!-- Palm -->
        <ellipse cx="50" cy="55" rx="22" ry="26" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        
        <!-- Thumb -->
        <ellipse cx="28" cy="48" rx="7" ry="13" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2" transform="rotate(-35 28 48)"/>
        <circle cx="24" cy="38" r="5.5" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        
        <!-- Index finger -->
        <rect x="40" y="15" width="8" height="25" rx="4" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        <circle cx="44" cy="13" r="5" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        
        <!-- Middle finger -->
        <rect x="50" y="10" width="8" height="28" rx="4" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        <circle cx="54" cy="8" r="5" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        
        <!-- Ring finger -->
        <rect x="60" y="15" width="8" height="25" rx="4" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        <circle cx="64" cy="13" r="5" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        
        <!-- Pinky -->
        <rect x="70" y="22" width="7" height="20" rx="3.5" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        <circle cx="73.5" cy="20" r="4.5" fill="url(#skinGradient)" stroke="#E5A572" stroke-width="2"/>
        
        <!-- Palm details -->
        <ellipse cx="42" cy="60" rx="3" ry="6" fill="#E5A572" opacity="0.15"/>
        <ellipse cx="50" cy="62" rx="3" ry="7" fill="#E5A572" opacity="0.15"/>
        <ellipse cx="58" cy="60" rx="3" ry="6" fill="#E5A572" opacity="0.15"/>
      </g>
    </svg>
    
    <!-- Sparkles around hand -->
    <svg class="sparkle sparkle-1" width="30" height="30" viewBox="0 0 24 24">
      <path d="M12 0L14 10L24 12L14 14L12 24L10 14L0 12L10 10Z" fill="var(--primary-pink)" opacity="0.6"/>
    </svg>
    <svg class="sparkle sparkle-2" width="25" height="25" viewBox="0 0 24 24">
      <path d="M12 0L14 10L24 12L14 14L12 24L10 14L0 12L10 10Z" fill="#ff6b9d" opacity="0.5"/>
    </svg>
    <svg class="sparkle sparkle-3" width="20" height="20" viewBox="0 0 24 24">
      <path d="M12 0L14 10L24 12L14 14L12 24L10 14L0 12L10 10Z" fill="var(--primary-pink)" opacity="0.7"/>
    </svg>
  </div>
  
  <div class="wave-text">Hi there Nancy Di Mummy!</div>
</div>
  
  <div id="notifDropdown">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:800;font-size:16px;">Notifications</div>
      <button id="markAllReadBtn" style="background:#fff;color:var(--primary-pink);border:2px solid var(--primary-pink);padding:6px 12px;border-radius:10px;font-size:13px;">Clear All</button>
    </div>
    <div id="notifList"></div>
  </div>


  <div id="step1" class="screen" style="display:block;">
    <h2>âœ¨ Welcome to Pink Chat</h2>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <input id="username" placeholder="Enter your username" style="width:100%" />
      <input id="password" type="text" placeholder="Enter your password" style="width:100%" />
    </div>
    <div style="margin-top:16px;">
      <button onclick="nextStep()" style="width:100%;">Next â†’</button>
    </div>
  </div>

  <div id="step2" class="screen">
    <h2>ðŸ“ Choose Your ID</h2>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <input id="userid" placeholder="Enter unique User ID" style="width:100%" />
      <label style="font-size:14px;color:var(--gray);font-weight:600;">Profile Photo (optional)</label>
      <input type="file" id="profilePhoto" accept="image/*" capture="environment" style="margin-top:6px;" />
    </div>
    <div style="margin-top:16px;">
      <button onclick="finishRegister()" style="width:100%;">Complete & Start Chatting</button>
    </div>
  </div>

  <div id="homeScreen" class="screen">
    <div id="defaultWhiteBox">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="profileBubble" id="profileBubble" onclick="showMyProfile()">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="var(--primary-pink)">
              <circle cx="12" cy="8" r="4"/>
              <path d="M12 14c-6.1 0-8 3.13-8 5v3h16v-3c0-1.87-1.9-5-8-5z"/>
            </svg>
          </div>
          <div style="font-weight:700;font-size:18px;color:var(--primary-pink);"></div>
        </div>
        <div class="mainOptions">
          <button onclick="openMatesPage()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px;">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            Mates
          </button>
          <button onclick="viewChatRooms()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px;">
              <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>
            </svg>
            Chats
          </button>
          <button onclick="searchMate()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:4px;">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            Search
          </button>
        </div>
      </div>
    </div>

    <div id="continueChatBanner"></div>

    <h2>ðŸ” Find Your Mate</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <input id="searchInput" placeholder="Enter mate's User ID" style="flex:1;min-width:200px;" />
      <button onclick="searchMate()">Search</button>
    </div>
    <div id="searchResult" style="margin-top:16px;"></div>
  </div>

  <div id="matesScreen" class="screen">
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:8px;">
        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
      </svg>
      Your Mates
    </h2>
    <div id="matesList"></div>
    <button class="back-small" onclick="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      Back
    </button>
  </div>

  <div id="profileScreen" class="screen">
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:8px;">
        <circle cx="12" cy="8" r="4"/>
        <path d="M12 14c-6.1 0-8 3.13-8 5v3h16v-3c0-1.87-1.9-5-8-5z"/>
      </svg>
      Profile
    </h2>
    <div id="profileContent"></div>
    <button class="back-small" onclick="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      Back
    </button>
  </div>

  <div id="chatScreen" class="screen">
    <h2 id="chatWith"></h2>
    <div id="typingIndicator"></div>
    <div id="chatBox"></div>
    
    <div class="chatInputControls">
      <input id="message" placeholder="Type a message..." />
      <button class="iconBtn" onclick="triggerPhotoChoose()" title="Send Photo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
      </button>
      <button class="iconBtn" onclick="toggleStickerPicker()" title="Send Sticker">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
      </button>
      <button id="sendBtn">Send</button>
    </div>
    
    <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhotoSelect(this)" />
    
    <div id="stickerPicker">
      <div id="stickerGrid"></div>
    </div>
    
    <button class="back-small" onclick="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      Back
    </button>
  </div>

  <div id="chatRoomsScreen" class="screen">
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;margin-right:8px;">
        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>
      </svg>
      Chat Rooms
    </h2>
    <div id="chatRoomList"></div>
    <button class="back-small" onclick="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      Back
    </button>
  </div>

  <div id="customAlert" style="display:none;position:fixed;top:20px;right:20px;
  background:#10b981;color:#fff;padding:14px 20px;border-radius:12px;
  box-shadow:0 6px 20px rgba(16,185,129,0.3);z-index:10000;font-weight:600;">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="white" style="vertical-align:middle;margin-right:6px;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    Profile updated successfully!
  </div>
  
  <!-- Fullscreen Photo Viewer -->
  <div id="photoViewer">
    <button id="photoViewerClose" onclick="closePhotoViewer()">â† Back</button>
    <img src="" alt="Photo" />
  </div>
  
  <script>
  function showCustomAlert(msg){
    const box=document.getElementById("customAlert");
    box.innerText=msg;
    box.style.display="block";
    setTimeout(()=>{box.style.display="none";},3000);
  }
  </script>

  <div id="fbStatus" style="margin:10px;font-size:14px;color:#555"></div>
</body>
</html>
